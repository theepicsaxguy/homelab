apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: mastodon

configMapGenerator:
  - name: mastodon-env
    literals:
      # --- Base Mastodon Config ---
      - RAILS_ENV=production
      - NODE_ENV=production
      - TZ=Europe/Stockholm
      - DB_HOST=mastodon-postgresql-pooler
      - DB_PORT=5432
      - DB_NAME=mastodon
      - DB_SSLMODE=verify-ca
      - DB_SSLROOTCERT=/opt/mastodon/.postgresql/root.crt
      - REDIS_HOST=mastodon-redis-master
      - REDIS_PORT=6379
      - REDIS_URL=redis://mastodon-redis-master:6379/0
      - SIDEKIQ_REDIS_URL=redis://mastodon-redis-master:6379/1
      - CACHE_REDIS_URL=redis://mastodon-redis-master:6379/2
      - STREAMING_REDIS_URL=redis://mastodon-redis-master:6379/3
      # --- Caching Optimizations ---
      - QUERY_CACHE_REDIS_URL=redis://mastodon-redis-master:6379/4
      # --- Elasticsearch ---
      - ES_ENABLED=true
      - ES_HOST=es.goingdark.social
      - ES_PORT=9200
      - ES_PRESET=single_node_cluster
      # --- Read Replica ---
      - REPLICA_DB_HOST=mastodon-postgresql-repl
      - REPLICA_DB_PORT=5432
      - REPLICA_DB_NAME=mastodon
      - REPLICA_PREPARED_STATEMENTS=false
      - REPLICA_DB_TASKS=false
      # --- Database Query Optimizations ---
      - DATABASE_TIMEOUT=60
      - STREAMING_DATABASE_TIMEOUT=10
      # --- Prometheus ---
      - MASTODON_PROMETHEUS_EXPORTER_ENABLED=true
      - MASTODON_PROMETHEUS_EXPORTER_LOCAL=true
      - SINGLE_USER_MODE=false
      - RAILS_LOG_TO_STDOUT=true
      - PREPARED_STATEMENTS=false
      - DB_POOL=15
      # --- Performance Optimizations ---
      #- FEED_PRELOAD_LIMIT=100
      #- LOCAL_TIMELINE_LIMIT=1000
      #- TIMELINE_PRELOAD_CACHE_SIZE=10000
      # --- Federation & Privacy ---
      - FETCH_REPLIES_ENABLED=true
      - IP_RETENTION_PERIOD=15552000
      # --- Performance  ---
      - MASTODON_USE_LIBVIPS=true
      # --- Admin Performance ---
      #- DISABLE_ADMIN_ANALYTICS=true
      #- ADMIN_ANALYTICS_CACHE_TTL=3600
      # --- Locale  ---
      - DEFAULT_LOCALE=en
      #- FORCE_DEFAULT_LOCALE=true
      # --- SMTP  ---
      - SMTP_DELIVERY_METHOD=smtp
      - SMTP_AUTH_METHOD=login
      - SMTP_SSL=true
      - SMTP_TLS=false
      - SMTP_ENABLE_STARTTLS_AUTO=false
      # --- Web Specific ---
      - PORT=3000
      - BIND=0.0.0.0
      - RAILS_SERVE_STATIC_FILES=true
      - WEB_CONCURRENCY=2
      - MAX_THREADS=5
      - STREAMING_API_BASE_URL=wss://goingdark.social
      # --- Streaming Specific ---
      - STREAMING_PORT=4000
      # --- Sidekiq Specific ---
      - SIDEKIQ_CONCURRENCY=15
      # --- S3 NON-SECRET Configuration ---
      - S3_ENABLED=true
      - S3_BUCKET=mastodata
      - S3_ALIAS_HOST=cdn.goingdark.social
      - S3_PROTOCOL=https
      - S3_REGION=us-west-1
      - S3_PERMISSION=public-read
      - EXTRA_MEDIA_HOSTS=https://cdn.goingdark.social

resources:
  - namespace.yaml
  - secretstore.yaml
  - serviceaccount.yaml
  - externalsecret.yaml
