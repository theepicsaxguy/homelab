{
  "$schema": "https://docs.renovatebot.com/renovate-schema.json",
  "extends": [
    "config:recommended",
    ":rebaseStalePrs",
    ":enablePreCommit",
    "docker:enableMajor",
    ":automergePatch",
    ":automergeMinor",
    "mergeConfidence:all-badges"
  ],
  "dependencyDashboard": true,
  "kustomize": {
    "managerFilePatterns": [
      "**/kustomization.yaml",
      "**/kustomization.yml",
      "**/kustomization.yaml.j2",
      "**/kustomization.yml.j2"
    ]
  },
  "helm-values": {
    "managerFilePatterns": [
      "k8s/**/values.yaml"
    ]
  },
  "customManagers": [
    {
      "customType": "regex",
      "managerFilePatterns": [
        "/\\.tf$/",
        "/\\.tftpl$/",
        "/\\.tfvars$/",
        "/\\.yaml$/",
        "/\\.sh$/"
      ],
      "matchStrings": [
        "(?<currentValue>[\\w+\\.\\-]*)['\\\",;]*\\s*#\\s?renovate:\\s+(?<datasource>\\S+)=(?<depName>\\S+)(?:\\s+registry=(?<registryUrl>\\S+))?(?:\\s+versioning=(?<versioning>\\S+))?",
        "https://github.com/(?<depName>[^/]+/[^/]+)/releases/download/(?<currentValue>[^/]+)/",
        "https://raw.githubusercontent.com/(?<depName>[^/]+/[^/]+)/(?<currentValue>[^/]+)/"
      ]
    },
    {
      "customType": "regex",
      "managerFilePatterns": ["/k8s/applications/games/minecraft/plugins/plugins\\.txt$"],
      "matchStrings": [
        "https://github\\.com/(?<depName>EssentialsX/Essentials|EssentialsX/EssentialsX-GUI|Multiverse/Multiverse-Core|Multiverse/Multiverse-SignPortals|MilkBowl/Vault|SniperTVmc/EssentialsX-GUI|EssentialsX)/releases/download/(?<currentValue>[^/]+)/"
      ],
      "datasourceTemplate": "github-releases"
    },
    {
      "customType": "regex",
      "managerFilePatterns": ["/k8s/applications/games/minecraft/plugins/kustomization\\.yaml$"],
      "matchStrings": [
        "PAPER_BUILD=(?<currentValue>\\d+) # renovate: datasource=github-releases depName=PaperMC/paper"
      ],
      "datasourceTemplate": "github-releases",
      "depNameTemplate": "PaperMC/paper"
    },
    {
      "customType": "regex",
      "managerFilePatterns": ["/Dockerfile$/", "/Dockerfile\\..*$/"],
      "matchStrings": [
        "ARG\\s+\\w+=(?<currentValue>[\\w+\\.\\-]*)['\\\"]?\\s*#\\s?renovate: (?<datasource>\\S+)=(?<depName>\\S+)\\s?(versioning=(?<versioning>\\S+))?"
      ]
    }
  ],
  "packageRules": [
    {
      "matchCategories": ["docker"],
      "registryUrls": ["registry.k8s.io"]
    },
    {
      "groupName": "Media containers",
      "matchDatasources": ["docker"],
      "matchPackageNames": [
        "/^ghcr\\.io\\/onedr0p\\/.+$/",
        "/^ghcr\\.io\\/jellyfin\\/.+$/"
      ]
    },
    {
      "groupName": "Netbird",
      "matchPackageNames": ["/docker.io/netbirdio/.*/"]
    },
    {
      "groupName": "Intel Device Plugins",
      "matchPackageNames": ["/intel-device-plugins/.*/"]
    },
    {
      "groupName": "Cilium",
      "automerge": true,
      "matchPackageNames": ["/cilium/.*/"]
    },
    {
      "matchManagers": ["terraform"],
      "matchDepTypes": ["provider", "required_provider"],
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true
    },
    {
      "matchManagers": ["helm-values", "helm-requirements"],
      "matchUpdateTypes": ["minor", "patch"],
      "automerge": true
    },
    {
      "groupName": "external-secrets",
      "matchPackageNames": ["/^ghcr.io/external-secrets//"]
    },
    {
      "groupName": "all dependencies",
      "matchPackageNames": ["*"]
    },
    {
      "description": "Prevent automatic upgrades for Talos and Kubernetes versions in tofu/ - require manual review",
      "matchFileNames": ["/tofu/.*\\.(tf|tfvars|tftpl)$/"],
      "matchPackageNames": ["siderolabs/talos", "kubernetes/kubernetes"],
      "automerge": false,
      "automergeType": "pr",
      "schedule": ["before 10am on monday"]
    },
    {
      "description": "Handle descheduler image from registry.k8s.io",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["registry.k8s.io/descheduler/descheduler"]
    },
    {
      "groupName": "Minecraft Plugins",
      "description": "Track GitHub-based Minecraft plugin updates",
      "matchFileNames": ["k8s/applications/games/minecraft/plugins/plugins.txt"],
      "matchPackageNames": [
        "EssentialsX/Essentials",
        "EssentialsX/EssentialsX-GUI", 
        "Multiverse/Multiverse-Core",
        "Multiverse/Multiverse-SignPortals",
        "MilkBowl/Vault",
        "PaperMC/paper"
      ]
    },
    {
      "groupName": "BedrockConnect",
      "description": "Track BedrockConnect Docker image updates",
      "matchDatasources": ["docker"],
      "matchPackageNames": ["pugmatt/bedrock-connect"]
    }
  ],
  "kubernetes": {
    "managerFilePatterns": ["/k8s/.+\\.yaml$/", "/k8s/.+\\.yml$/"]
  },
  "hostRules": [
    {
      "hostType": "docker",
      "matchHost": "registry.k8s.io"
    }
  ]
}
