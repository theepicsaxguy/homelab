apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
resources:
  - base
  - announce.yaml
  - ip-pool.yaml

patches:
  - patch: |
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: cilium-config
        namespace: kube-system
      data:
        debug: "false"
        enable-ipv4: "true"
        enable-ipv6: "false"
        tunnel-protocol: "vxlan"
        routing-mode: "tunnel"
        enable-ipv4-masquerade: "true"
        kube-proxy-replacement: "true"
        cluster-name: "talos"
        cluster-id: "1"
        # Core features
        enable-host-reachable-services: "true"
        enable-external-ips: "true"
        enable-node-port: "true"
        enable-auto-protect-node-port-range: "true"
        enable-health-check-nodeport: "true"
        enable-session-affinity: "true"
        enable-svc-source-range-check: "true"
        enable-l7-proxy: "true"
        enable-endpoint-routes: "true"
        enable-local-node-route: "true"
        # BPF and networking
        bpf-lb-external-clusterip: "true"
        bpf-lb-sock: "true"
        bpf-host-legacy-routing: "true"
        ipv4-native-routing-cidr: "10.0.0.0/8"
        # DNS
        dnsproxy-enable-transparent-mode: "true"
        # Load balancer settings
        loadbalancer-algorithm: "maglev"
        enable-lb-ipam: "true"
        # Gateway API
        enable-gateway-api: "true"
        enable-envoy-config: "true"
        # Hubble
        enable-hubble: "true"
        hubble-disable-tls: "false"
        hubble-listen-address: ":4244"
        # Resource limits
        agent-resources-limits-cpu: "1000m"
        agent-resources-limits-memory: "1Gi"
        agent-resources-requests-cpu: "200m"
        agent-resources-requests-memory: "512Mi"
        operator-resources-limits-cpu: "500m"
        operator-resources-limits-memory: "256Mi"
        operator-resources-requests-cpu: "50m"
        operator-resources-requests-memory: "128Mi"
        # Security
        enable-cgroup-v2: "true"
        cgroup-root: "/sys/fs/cgroup"
        enable-bpf-clock-probe: "true"
        enable-l2-announcements: "true"
        enable-endpoint-slice: "true"
        enable-k8s-networkpolicy: "true"
        enable-auto-protect-node-port-range: "true"
        k8s-client-qps: "20"
        k8s-client-burst: "100"
        # Kubernetes API server configuration
        k8s-require-ipv4-pod-cidr: "false"
        k8s-require-ipv6-pod-cidr: "false"
        # Operator specific settings
        operator-api-serve-addr: ":9234"
        operator-prometheus-serve-addr: ":9963"
        # Agent configuration
        agent-health-port: "9879"
        auto-mount-cgroup: "false"  # Disable auto-mounting since we're on Talos
        clean-cilium-state: "false"  # Don't clean state on startup since we're using persistent BPF maps
        bpf-map-dynamic-size-ratio: "0.0025"
        # Container runtime configuration
        container-runtime: "containerd"
        container-runtime-endpoint: "unix:///run/containerd/containerd.sock"
    target:
      kind: ConfigMap
      name: cilium-config

  - patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: cilium-operator
        namespace: kube-system
      spec:
        template:
          spec:
            containers:
            - name: cilium-operator
              resources:
                limits:
                  cpu: "500m"
                  memory: "256Mi"
                requests:
                  cpu: "50m"
                  memory: "128Mi"
              readinessProbe:
                httpGet:
                  path: /healthz
                  port: 9234
                  scheme: HTTP
                initialDelaySeconds: 30
                periodSeconds: 5
                timeoutSeconds: 3
                failureThreshold: 5
              livenessProbe:
                httpGet:
                  path: /healthz
                  port: 9234
                  scheme: HTTP
                initialDelaySeconds: 60
                periodSeconds: 10
                timeoutSeconds: 3
                failureThreshold: 3
    target:
      kind: Deployment
      name: cilium-operator

  - patch: |
      apiVersion: apps/v1
      kind: DaemonSet
      metadata:
        name: cilium
        namespace: kube-system
      spec:
        template:
          spec:
            initContainers:
            - name: mount-cgroup
              securityContext:
                privileged: true
                capabilities:
                  add:
                    - SYS_ADMIN
                    - SYS_CHROOT
                    - SYS_PTRACE
            - name: clean-cilium-state
              securityContext:
                privileged: true
              env:
                - name: CILIUM_BPF_STATE
                  value: "false"
                  valueFrom: null
                - name: CILIUM_ALL_STATE
                  value: "false"
                  valueFrom: null
            containers:
            - name: cilium-agent
              securityContext:
                privileged: true
                capabilities:
                  add:
                    - CHOWN
                    - KILL
                    - NET_ADMIN
                    - NET_RAW
                    - IPC_LOCK
                    - SYS_ADMIN
                    - SYS_RESOURCE
                    - DAC_OVERRIDE
                    - FOWNER
                    - SETGID
                    - SETUID
    target:
      kind: DaemonSet
      name: cilium
