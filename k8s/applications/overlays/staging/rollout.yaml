apiVersion: argoproj.io/v1alpha1
kind: Rollout
metadata:
  name: apps-rollout-staging
  namespace: staging-apps
spec:
  replicas: 2
  revisionHistoryLimit: 3
  selector:
    matchLabels:
      app.kubernetes.io/part-of: applications
      app.kubernetes.io/instance: apps-service
  strategy:
    blueGreen:
      activeService: apps-service
      previewService: apps-service-preview
      autoPromotionEnabled: false     # Require manual promotion in staging
      scaleDownDelaySeconds: 300      # Wait 5 minutes before scaling down old version
      previewReplicaCount: 2          # Match production replica count
      antiAffinity:
        requiredDuringSchedulingIgnoredDuringExecution: {}
      prePromotionAnalysis:
        templates:
          - templateName: apps-health
        args:
          - name: service-name
            value: apps-service-preview
      postPromotionAnalysis:
        templates:
          - templateName: apps-health
        args:
          - name: service-name
            value: apps-service
      cleanup:
        keepHistory: 2                # Keep two revision histories in staging
  template:
    metadata:
      labels:
        app.kubernetes.io/part-of: applications
        app.kubernetes.io/instance: apps-service
      annotations:
        environment.type: staging
    spec:
      containers:
        - name: apps
          image: apps-service:v1.0.0
          resources:
            requests:
              cpu: 500m
              memory: 256Mi
            limits:
              cpu: 2000m
              memory: 512Mi
          env:
            - name: ENVIRONMENT
              value: staging
            - name: METRICS_ENABLED
              value: "true"
            - name: TRACING_ENABLED
              value: "true"
      affinity:
        podAntiAffinity:
          preferredDuringSchedulingIgnoredDuringExecution:
            - weight: 100
              podAffinityTerm:
                labelSelector:
                  matchLabels:
                    app.kubernetes.io/part-of: applications
                    app.kubernetes.io/instance: apps-service
                topologyKey: kubernetes.io/hostname
