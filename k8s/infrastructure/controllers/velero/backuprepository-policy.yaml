---
# Kyverno ClusterPolicy to set longer maintenance frequency for Backblaze B2 repositories
# This reduces API calls to stay within Backblaze free tier daily transaction limits
apiVersion: kyverno.io/v1
kind: ClusterPolicy
metadata:
  name: velero-backblaze-maintenance-frequency
  annotations:
    policies.kyverno.io/title: Set Backblaze B2 Repository Maintenance Frequency
    policies.kyverno.io/category: Velero
    policies.kyverno.io/severity: medium
    policies.kyverno.io/subject: BackupRepository
    policies.kyverno.io/description: >-
      Sets maintenance frequency to 24 hours for Backblaze B2 repositories to reduce
      API transaction calls and stay within free tier daily limits. Backblaze has
      transaction caps that can be exceeded with frequent maintenance operations.
spec:
  background: true
  rules:
    - name: set-backblaze-maintenance-frequency
      match:
        any:
          - resources:
              kinds:
                - BackupRepository
              namespaces:
                - velero
      preconditions:
        all:
          - key: "{{ request.object.spec.backupStorageLocation || '' }}"
            operator: Equals
            value: "backblaze-b2"
      mutate:
        patchStrategicMerge:
          spec:
            # Set maintenance to run once per day instead of default 1 hour
            # This significantly reduces Backblaze B2 transaction API calls
            maintenanceFrequency: 24h0m0s
