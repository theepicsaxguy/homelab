# Sensors used to Monitor Jarvis
mqtt:
  sensor:
  - name: "Jarvis Last Msg"
    state_topic: "house/polly/lastmsg"
  - name: "Jarvis Last Location"
    state_topic: "house/polly/lastloc"
  - name: "Jarvis Last Msg Time"
    state_topic: "house/polly/msgtime"


sensor:
  # Making some template sensors to simpify TTS Briefings and Announcements.
  - platform: template
    sensors:

      tts_greeting:
        friendly_name: TTS Hälsning
        value_template: >
          {% if now().hour < 12 %}
          God morgon.
          {% elif now().hour >= 12 and now().hour < 17 %}
          God eftermiddag.
          {% else %}
          God kväll.
          {% endif %}

      tts_confirmation:
        friendly_name: TTS Bekräftelse
        value_template: >
          {{ [
            'Okej.',
            'Om du insisterar.',
            'Jag är rädd att jag inte kan göra det, jag skojar,',
            'Låt mig ta hand om det.',
            'Som du önskar.',
            'Jag tar hand om det.',
            'Inget problem.',
            'Ska göras.',
            'Jag tror att jag klarar det.',
            'Jobbar med det nu.',
            ', Åh, du pratade med mig. Låt mig ta hand om det.'
            'Varför inte. Det är inte som om jag någonsin sover.',
            'Jag borde inte ens vara här idag. Men vad som helst.',
            'Du sa inte magiska ordet. , Åh, strunt i det. Jag tar hand om det.',
            'Roligt, jag höll på att göra det.',
            'Det krävs fortfarande terabytes av beräkningar innan jag kan., Åh, vad som helst.'
            ] | random }}

      tts_interuption:
        friendly_name: TTS Avbrott
        value_template: >
          {% if is_state('device_tracker.person1', 'home') %}
            {{ [
                "Fru, ",
                "Ursäkta fru, ",
                "Ursäkta mig wilma, ",
                "wilma, ",
                "Jag menar inte att avbryta fru, ",
                ] | random }}
          {% elif is_state('device_tracker.person2', 'home') %}
            {{ [
                'Herr, ',
                'Ursäkta herr, ',
                'Ursäkta mig chef, ',
                'Chef, ',
                'Jag menar inte att avbryta chef, '
                ] | random }}
          {% else %}
            {{ [
              'Ursäkta mig, ',
              'Ursäkta, ',
              'Jag ber om ursäkt, ',
              'Jag menar inte att störa, men, ',
              'Förlåt att jag avbryter, men. '
              ] | random }}
          {% endif %}


      tts_issue_announcement:
        friendly_name: TTS Meddelande om Problem
        value_template: >
          {{ [
            'Maison Des Lunes Nödalarm!',
            'Maison Des Lunes, Vi har ett problem!',
            'Du kanske inte gillar det här.',
            'Det är något som behöver din uppmärksamhet.'
            ] | random }}
      
      tts_time_is:
        friendly_name: TTS Tiden är
        value_template: >
          {% if is_state('binary_sensor.morning','on') %}
            Idag är det {{states.sensor.today_is_day_day.state }}, {{ as_timestamp(now()) | timestamp_custom('%d %B %Y') }} .
          {% else %}
            Klockan är {{ now().strftime("%H:%M") }} .
          {% endif %}
      
      

      
script:
  speech_engine:
    sequence:
      - condition: state
        entity_id: binary_sensor.is_anyone_home
        state: 'on'
      - condition: state
        entity_id: input_boolean.semesterresa
        state: 'off'
      # Your existing conditions and services
      # ...
    
      # Add MQTT to publish the message
      - service: mqtt.publish
        data_template:
          topic: house/polly/lastmsg
          payload: >
            {%- macro getReport() -%}
              {{ message }}
            {%- endmacro -%}
            {%- macro cleanup(data) -%}
              {%- for item in data.split("\n")  if item | trim != "" -%}
                {{ item | trim }} {% endfor -%}
            {%- endmacro -%}
            {%- macro mother_of_all_macros() -%}
              {{ getReport() }}
            {%- endmacro -%}
            {{- cleanup(mother_of_all_macros()) -}}
          retain: true
    
      # Add MQTT to publish the time
      - service: mqtt.publish
        data_template:
          topic: house/polly/msgtime
          payload: '{{ now().strftime("%-I") }}:{{ now().strftime("%M") }} {{ now().strftime("%p") }}'
          retain: true
      
      - service: tts.cloud_say
        data:
          entity_id: |-
              {% if entity_id is defined and entity_id %}
                {{ entity_id }}
              {% elif states('sensor.room_audio') and states('sensor.room_audio') != 'unavailable' %}
                {{ states('sensor.room_audio') }}
              {% else %}
                media_player.hallen  # Replace with a default entity ID
              {% endif %}
              
          message: "{{ message }}"

  
  
  
 
    
  announcement:
    #variables:
#      who: "{{ states('sensor.room_audio') }}"
    sequence:
    - service: script.speech_engine
      data:
        who: "{{ states('sensor.room_audio') }}"
        message: >
          {% if states('sensor.wilma_room') == who and states('sensor.benjamin_room')== who  %}
            {{ 
              ['Ursäkta alla, ',
              'Förlåt mig, ',
              'Jag ber om ursäkt, ',
              'Eftersom ni alla är här, ',
              'Jag är ledsen att avbryta, men. ',
              'När vi ändå är samlade,'] 
              | random }}
          {% elif states('sensor.wilma_room') == who  %}
            {{ 
              ["Fru,",
                "Ursäkta mig fru,",
                "Ursäkta wilma,",
                "wilmaherine,",
                "Jag menar inte att avbryta frun,"
                ] | random }}
          {% elif states('sensor.benjamin_room') == who  %}
            {{ 
              ['Herre, ',
              'Ursäkta mig herre, ',
              'Ursäkta benjamin, ',
              'Boss, ',
              'Jag menar inte att avbryta herren, '
              ] | random }}
          {% else %}
            {{ 
              ['Ursäkta mig, ',
              'Förlåt mig, ',
              'Jag ber om ursäkt, ',
              'Jag menar inte att störa, men, ',
              'Jag är ledsen att avbryta, men. '
              ] | random }}
          {% endif %} 
          {{ message }}"
#   speech_engine_2:
#     sequence:
#     - service: tts.cloud_say
#       data_template:
#         entity_id: "{{ who }}"
#         message: "{{ message }}"
#         cache: true
  
  briefing:
    #variables:
#      who: "{{ states('sensor.room_audio') }}"
    sequence:
    - service: script.speech_engine
      data:
        who: '{{ who }}'
        message:  >-
          {% if now().strftime('%H')|int < 12%}
            God morgon.
          {% elif now().strftime('%H')|int >= 12 and now().strftime('%H')|int < 17 %}
            God eftermiddag.
          {% else %}
            God kväll.
          {% endif %}
          {% if states('sensor.wilma_room') == who and states('sensor.benjamin_room') == who  %}
            alla.
          {% elif states('sensor.wilma_room') == who  %}
            Fru.
          {% elif states('sensor.benjamin_room') == who  %}
            Herre.
          {% else %}
            
          {% endif %}
          {{ message }}
  daily_briefing:
    sequence:
    - service: script.speech_engine
      data:
        message: !include ../speech/daily_briefing.yaml
  
  jarvis_already_done:
    #variables:
#      who: "{{ states('sensor.room_audio') }}"
    sequence:
    - service: script.speech_engine
      data:
        who: "{{ states('sensor.room_audio') }}"
        message:  >-
          {{ [
          'Det har jag redan ordnat med.', 
          'Det verkar som någon redan har gjort det, men jag tar gärna åt mig äran.',
          'Jag är så snabb att det redan är gjort.'
          ]| random }}
  jarvis_response:
    sequence:
    - service: script.speech_engine
      data:
        who: "{{ states('sensor.room_audio') }}"
        message:  >-
          {{ [
          'Okej.', 
          'Om du insisterar.',
          'Jag är rädd att jag inte kan göra det, jag skämtar,',
          'Lämna det åt mig.',
          'Som du önskar.',
          'Jag är på det.',
          'Inget problem.',
          'Jag tror jag kan hantera det.',
          'Jobbar på det nu.',
          '.Åh, du pratade med mig. Låt mig ta hand om det.'
          'Varför inte. Det är inte som om jag någonsin sover.',
          'Jag borde inte ens vara här idag. Men vad som helst.',
          'Du sa inte magiska ordet.  ,Åh strunt samma. Jag tar hand om det.',
          'Roligt, jag höll just på med det.',
          'Det krävs fortfarande terabytes av beräkningar innan jag kan.        ,Åh, vad som helst.'
          ] | random }}
  house_party_protocol_on:
    sequence:
      - delay: 00:00:05
      - service: homeassistant.turn_on
        entity_id: group.incense
      - service: script.status_annc
        data_template:
          who: "{{ states('sensor.room_audio') }}"
          call_house_party_protocol_enabled: 1


  house_party_protocol_off:
    sequence:
      - delay: 00:00:05
      - service: homeassistant.turn_off
        entity_id: group.incense
      - service: script.status_annc
        data_template:
          who: "{{ states('sensor.room_audio') }}"
          call_house_party_protocol_disabled: 1

  google_interjection:
    sequence:
      - service: script.status_annc
        data:
          who: "{{ states('sensor.room_audio') }}"
          call_confirmation: 1

  jarvis_said_what:
    sequence:
      - service: script.speech_engine
        data:
          who: "{{ states('sensor.room_audio') }}"
          message: >
            {{ states('sensor.lastmsg') }}




