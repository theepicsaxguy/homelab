# Verify existing PVC from Zalando Spilo backup restore
# This PVC (authentik-postgresql-1) has already been restored from backup
# We just need to verify it exists and is bound before proceeding
apiVersion: v1
kind: ServiceAccount
metadata:
  name: verify-restored-pvc
  namespace: auth
---
apiVersion: rbac.authorization.k8s.io/v1
kind: Role
metadata:
  name: verify-restored-pvc
  namespace: auth
rules:
- apiGroups: [""]
  resources: ["persistentvolumeclaims"]
  verbs: ["get", "list"]
---
apiVersion: rbac.authorization.k8s.io/v1
kind: RoleBinding
metadata:
  name: verify-restored-pvc
  namespace: auth
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: verify-restored-pvc
subjects:
- kind: ServiceAccount
  name: verify-restored-pvc
  namespace: auth
---
apiVersion: batch/v1
kind: Job
metadata:
  name: verify-restored-pvc
  namespace: auth
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      serviceAccountName: verify-restored-pvc
      securityContext:
        runAsNonRoot: true
        runAsUser: 65534  # nobody
        runAsGroup: 65534
        fsGroup: 65534
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: verify
        image: bitnami/kubectl:latest
        command:
        - sh
        - -c
        - |
          set -e
          echo "=== Verifying Restored PVC ==="

          PVC_NAME="authentik-postgresql-1"

          echo "Checking if PVC exists..."
          if ! kubectl get pvc "$PVC_NAME" -n auth; then
            echo "ERROR: PVC $PVC_NAME does not exist!"
            echo "Please restore the PVC from Zalando Spilo backup first."
            exit 1
          fi

          echo ""
          echo "Checking PVC status..."
          PVC_PHASE=$(kubectl get pvc "$PVC_NAME" -n auth -o jsonpath='{.status.phase}')
          echo "PVC Phase: $PVC_PHASE"

          if [ "$PVC_PHASE" != "Bound" ]; then
            echo "WARNING: PVC is not bound (current: $PVC_PHASE)"
            echo "Waiting for PVC to be bound..."
            kubectl wait --for=jsonpath='{.status.phase}'=Bound \
              pvc/"$PVC_NAME" -n auth --timeout=300s || {
              echo "ERROR: PVC did not become bound within timeout"
              exit 1
            }
          fi

          echo ""
          echo "PVC Details:"
          kubectl get pvc "$PVC_NAME" -n auth -o yaml | grep -E "name:|namespace:|phase:|storageClassName:|capacity:"

          echo ""
          echo "âœ“ PVC verified and ready for recovery process"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
