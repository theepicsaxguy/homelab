apiVersion: batch/v1
kind: Job
metadata:
  name: mastodon-migrate-nightly-2025-07-31 # renovate: datasource=docker depName=ghcr.io/glitch-soc/mastodon
  namespace: mastodon
spec:
  template:
    spec:
      serviceAccountName: mastodon-eso-reader
      containers:
        - name: migrate
          image: ghcr.io/glitch-soc/mastodon:nightly.2025-07-31
          command:
            - /bin/bash
            - -c
            - bundle exec rails db:migrate
          envFrom:
            - secretRef:
                name: mastodon-app-secrets
            - secretRef:
                name: mastodon-db-url
            - configMapRef:
                name: mastodon-core-env
            - configMapRef:
                name: mastodon-db-env
            - configMapRef:
                name: mastodon-cache-env
            - configMapRef:
                name: mastodon-search-env
            - configMapRef:
                name: mastodon-metrics-env
            - configMapRef:
                name: mastodon-features-env
            - configMapRef:
                name: mastodon-storage-env
            - configMapRef:
                name: mastodon-smtp-env
          volumeMounts:
            - name: db-ca
              mountPath: /opt/mastodon/.postgresql/root.crt
              subPath: ca.crt
      restartPolicy: OnFailure
      volumes:
        - name: db-ca
          secret:
            secretName: mastodon-postgresql-server
            items:
              - key: ca.crt
                path: ca.crt
