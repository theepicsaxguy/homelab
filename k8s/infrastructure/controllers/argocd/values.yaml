# https://github.com/argoproj/argo-helm/blob/main/charts/argo-cd/values.yaml
configs:
  cm:
    create: true
    application.resourceTrackingMethod: annotation+label
    admin.enabled: true
    url: https://argocd.pc-tips.se
    kustomize.buildOptions: "--enable-helm"
    accounts.kubechecks: apiKey
    policy.csv: |
      p, role:kubechecks, applications, get, */*, allow
      p, role:kubechecks, applications, list, */*, allow
      p, role:kubechecks, applications, sync, */*, allow
      g, kubechecks, role:kubechecks

  cmp:
    create: true
    plugins:
      kustomize-build-with-helm:
        generate:
          command: [ sh, -c ]
          args: [ kustomize build --enable-helm ]

  params:
    controller.diff.server.side: true
    server.insecure: "false"
    server.tls.certificate.secretName: "argocd-server-tls"

server:
  extraArgs: []                         # No --insecure flag, so HTTPS listener will start
  tls:
    certificate:
      secretName: argocd-server-tls
  volumes:
    - name: internal-ca-bundle
      configMap:
        name: internal-ca-bundle
        items:
          - key: ca.crt
            path: internal-ca.crt
  volumeMounts:
    - name: internal-ca-bundle
      mountPath: /etc/ssl/certs/internal-ca.crt
      subPath: internal-ca.crt
  service:
    servicePortHttps: 443
    servicePortHttp: 80
    targetPortHttp: 8080
    targetPortHttps: 8080
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      memory: 1Gi

repoServer:
  containerSecurityContext:
    readOnlyRootFilesystem: true
  tls:
    enabled: true
    certificate:
      secretName: argocd-repo-server-tls
  volumes:
    - name: cmp-kustomize-build-with-helm
      configMap:
        name: argocd-cmp-cm
    - name: cmp-tmp
      emptyDir: {}
    - name: internal-ca-bundle
      configMap:
        name: internal-ca-bundle
        items:
          - key: ca.crt
            path: internal-ca.crt
  volumeMounts:
    - name: internal-ca-bundle
      mountPath: /etc/ssl/certs/internal-ca.crt
      subPath: internal-ca.crt
  resources:
    requests:
      cpu: 100m
      memory: 256Mi
    limits:
      memory: 2Gi
  extraContainers:
    - name: kustomize-build-with-helm
      command:
        - argocd-cmp-server
      image: '{{ default .Values.global.image.repository .Values.repoServer.image.repository }}:{{ default (include "argo-cd.defaultTag" .) .Values.repoServer.image.tag }}'
      securityContext:
        runAsNonRoot: true
        runAsUser: 999
        allowPrivilegeEscalation: false
        readOnlyRootFilesystem: true
        seccompProfile:
          type: RuntimeDefault
        capabilities:
          drop: [ ALL ]
      volumeMounts:
        - name: plugins
          mountPath: /home/argocd/cmp-server/plugins
        - name: cmp-kustomize-build-with-helm
          mountPath: /home/argocd/cmp-server/config/plugin.yaml
          subPath: kustomize-build-with-helm.yaml
        - name: cmp-tmp
          mountPath: /tmp

controller:
  tls:
    enabled: true
    certificate:
      secretName: argocd-application-controller-tls
  volumes:
    - name: internal-ca-bundle
      configMap:
        name: internal-ca-bundle
        items:
          - key: ca.crt
            path: internal-ca.crt
  volumeMounts:
    - name: internal-ca-bundle
      mountPath: /etc/ssl/certs/internal-ca.crt
      subPath: internal-ca.crt

applicationSet:
  resources:
    requests:
      cpu: 50m
      memory: 64Mi
    limits:
      memory: 1Gi

notifications:
  enabled: false
  resources:
    requests:
      cpu: 100m
      memory: 64Mi
    limits:
      cpu: 1000m
      memory: 128Mi
