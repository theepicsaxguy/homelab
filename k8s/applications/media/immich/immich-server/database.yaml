apiVersion: "acid.zalan.do/v1"
kind: postgresql
metadata:
  name: immich-postgresql
  namespace: immich
spec:
  initContainers:
  - name: install-vchord
    image: debian:12-slim
    command: ["/bin/bash", "-ec"]
    args:
      - |
        apt-get update -qq
        apt-get install -y --no-install-recommends wget ca-certificates dpkg
        wget -qO /tmp/vchord.deb \
          https://github.com/tensorchord/VectorChord/releases/download/0.3.0/postgresql-17-vchord_0.3.0-1_amd64.deb
        dpkg -x /tmp/vchord.deb /
    volumeMounts:
    - name: vchord-lib
      mountPath: /vectorchord

  teamId: "immich"
  volume:
    size: 10Gi
  numberOfInstances: 1
  users:
    immich:
      - superuser
      - createdb
  databases:
    immich: immich
  preparedDatabases:
    immich:
      extensions:
        pgvector: public
        vectorchord: public

  additionalVolumes:
  - name: vchord-lib-lib
    mountPath: /usr/lib/postgresql/17/lib
    subPath: usr/lib/postgresql/17/lib
    targetContainers: [all]
    volumeSource:
      emptyDir: {}
  - name: vchord-lib-extension
    mountPath: /usr/share/postgresql/17/extension
    subPath: usr/share/postgresql/17/extension
    targetContainers: [all]
    volumeSource:
      emptyDir: {}

  postgresql:
    version: "17"
    parameters:
      shared_preload_libraries: "vchord,pgextwlist"

  enableConnectionPooler: false
  resources:
    requests:
      cpu: 200m
      memory: 512Mi
    limits:
      cpu: 1000m
      memory: 1Gi
