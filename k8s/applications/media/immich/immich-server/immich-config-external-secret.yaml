apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: immich-immich-config-secret
  namespace: immich
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-backend
  target:
    name: immich-immich-config-secret
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        immich-config.yaml: |
              ffmpeg:
                accel: disabled
                accelDecode: false
                acceptedAudioCodecs:
                - aac
                - mp3
                - libopus
                - pcm_s16le
                acceptedContainers:
                - mov
                - ogg
                - webm
                acceptedVideoCodecs:
                - h264
                bframes: -1
                cqMode: auto
                crf: 23
                gopSize: 0
                maxBitrate: "0"
                preferredHwDevice: auto
                preset: ultrafast
                refs: 0
                targetAudioCodec: aac
                targetResolution: "720"
                targetVideoCodec: h264
                temporalAQ: false
                threads: 0
                tonemap: hable
                transcode: required
                twoPass: false
              image:
                colorspace: p3
                extractEmbedded: false
                preview:
                  format: jpeg
                  quality: 80
                  size: 1440
                thumbnail:
                  format: webp
                  quality: 80
                  size: 250
              job:
                backgroundTask:
                  concurrency: 5
                faceDetection:
                  concurrency: 2
                library:
                  concurrency: 5
                metadataExtraction:
                  concurrency: 5
                migration:
                  concurrency: 5
                notifications:
                  concurrency: 5
                search:
                  concurrency: 5
                sidecar:
                  concurrency: 5
                smartSearch:
                  concurrency: 2
                thumbnailGeneration:
                  concurrency: 3
                videoConversion:
                  concurrency: 1
              library:
                scan:
                  cronExpression: 0 0 * * *
                  enabled: true
                watch:
                  enabled: false
              logging:
                enabled: true
                level: log
              machineLearning:
                clip:
                  enabled: true
                  modelName: ViT-B-32__openai
                duplicateDetection:
                  enabled: true
                  maxDistance: 0.01
                enabled: true
                facialRecognition:
                  enabled: true
                  maxDistance: 0.5
                  minFaces: 1
                  minScore: 0.7
                  modelName: buffalo_l
              map:
                darkStyle: https://tiles.immich.cloud/v1/style/dark.json
                enabled: true
                lightStyle: https://tiles.immich.cloud/v1/style/light.json
              metadata:
                faces:
                  import: true
              newVersionCheck:
                enabled: true
              oauth:
                enabled: true
                issuerUrl: "https://sso.pc-tips.se/application/o/photo/"
                scope: "openid email profile"
                autoLaunch: true
                autoRegister: true
                buttonText: "Login with SSO"
                clientId: "{{ .clientId }}"
                clientSecret: "{{ .clientSecret }}"
              passwordLogin:
                enabled: true
              reverseGeocoding:
                enabled: true
              theme:
                customCss: ""
              trash:
                days: 30
                enabled: true
              user:
                deleteDelay: 7
  data:
    - secretKey: clientId
      remoteRef:
        key: 3b511ff8-2630-472d-bc6e-b2e3013cb601
    - secretKey: clientSecret
      remoteRef:
        key: 3c78fc60-c8b2-499c-9e03-b2e3013ce060
