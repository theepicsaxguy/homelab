apiVersion: apps/v1
kind: Deployment
metadata:
  name: tmail
  namespace: tmail
  labels:
    app.kubernetes.io/name: tmail
    app.kubernetes.io/part-of: web
spec:
  replicas: 1
  selector:
    matchLabels:
      app.kubernetes.io/name: tmail
  template:
    metadata:
      labels:
        app.kubernetes.io/name: tmail
    spec:
      securityContext:
        seccompProfile:
          type: RuntimeDefault
      containers:
        - name: tmail
          image: ghcr.io/linagora/tmail-web:v0.23.1
          imagePullPolicy: IfNotPresent
          securityContext:
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL
              add:
                - CHOWN
          resources:
            requests:
              cpu: '100m'
              memory: '256Mi'
            limits:
              cpu: '500m'
              memory: '512Mi'
          ports:
            - containerPort: 8080
              name: http
          env:
            - name: OIDC_SCOPES
              value: 'openid,profile,email'
            - name: DOMAIN_REDIRECT_URL
              value: 'https://webmail.peekoff.com'
            - name: WEB_OIDC_CLIENT_ID
              valueFrom:
                secretKeyRef:
                  name: es-tmail-secrets
                  key: WEB_OIDC_CLIENT_ID
            - name: OIDC_ISSUER
              value: 'https://sso.peekoff.com/application/o/tmail/'
            - name: OIDC_AUTHORIZATION_ENDPOINT
              value: 'https://sso.peekoff.com/application/o/authorize/'
            - name: OIDC_TOKEN_ENDPOINT
              value: 'https://sso.peekoff.com/application/o/token/'
            - name: OIDC_USERINFO_ENDPOINT
              value: 'https://sso.peekoff.com/application/o/userinfo/'
            - name: OIDC_JWKS_ENDPOINT
              value: 'https://sso.peekoff.com/application/o/jwks/'
            - name: OIDC_END_SESSION_ENDPOINT
              value: 'https://sso.peekoff.com/application/o/end-session/'
            - name: JMAP_HOST
              value: 'mail.peekoff.com'
            - name: PLATFORM
              value: 'other'
            - name: WS_ECHO_PING
              value: 'false'
            - name: COZY_INTEGRATION
              value: 'false'
            - name: APP_GRID_AVAILABLE
              value: 'unsupported'
            - name: FCM_AVAILABLE
              value: 'unsupported'
          volumeMounts:
            - name: nginx-cache
              mountPath: /var/cache/nginx
            - name: nginx-log
              mountPath: /var/log/nginx
            - name: nginx-run
              mountPath: /var/run/nginx
          livenessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 90
            periodSeconds: 30
            timeoutSeconds: 30
            failureThreshold: 6
          readinessProbe:
            httpGet:
              path: /
              port: 8080
            initialDelaySeconds: 60
            periodSeconds: 20
            timeoutSeconds: 20
            failureThreshold: 8
      volumes:
        - name: nginx-cache
          emptyDir: {}
        - name: nginx-log
          emptyDir: {}
        - name: nginx-run
          emptyDir: {}
