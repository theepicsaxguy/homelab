apiVersion: batch/v1
kind: Job
metadata:
  name: fix-pgdata-permissions
  namespace: auth
  annotations:
    # PodSecurity warnings are expected - this job must run as root to chown files
    # This is a one-time recovery operation, not production workload
    pod-security.kubernetes.io/enforce: privileged
    pod-security.kubernetes.io/audit: privileged
    pod-security.kubernetes.io/warn: privileged
spec:
  template:
    spec:
      restartPolicy: Never
      # NOTE: Must run as root to chown files. PodSecurity warnings are expected and acceptable here.
      # This is a one-time recovery operation that requires elevated privileges.
      securityContext:
        runAsUser: 0  # Required to chown files
        runAsGroup: 0
        fsGroup: 26
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: fix-perms
        image: busybox
        command:
        - sh
        - -c
        - |
          echo "=== Current state ==="
          ls -ld /data/pgdata
          stat -c '%a %U:%G (%u:%g)' /data/pgdata
          echo ""
          echo "=== Step 1: Remove setgid and fix all permissions first (before ownership) ==="
          # First make everything accessible
          chmod -R 777 /data/pgdata
          # Remove setgid bits
          find /data/pgdata -type d -exec chmod g-s {} \;
          echo ""
          echo "=== Step 2: Set correct permissions for directories and files ==="
          # Set directories to 700
          find /data/pgdata -type d -exec chmod 700 {} \;
          # Set files to 600
          find /data/pgdata -type f -exec chmod 600 {} \;
          echo ""
          echo "=== Step 3: Fix ownership to postgres (26:26) ==="
          chown -R 26:26 /data/pgdata
          echo ""
          echo "=== Step 4: Verify no setgid bits remain ==="
          SETGID_COUNT=$(find /data/pgdata -type d -perm -2000 2>/dev/null | wc -l)
          echo "Directories with setgid: $SETGID_COUNT"
          echo ""
          echo "=== Verification ==="
          ls -ld /data/pgdata
          stat -c '%a %U:%G (%u:%g)' /data/pgdata
          echo ""
          echo "Sample subdirectory permissions:"
          ls -la /data/pgdata/ | head -10
          echo "âœ“ Permissions fixed!"
        volumeMounts:
        - name: data
          mountPath: /data
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            add:
            - CHOWN
            - FOWNER
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: authentik-postgresql-1

