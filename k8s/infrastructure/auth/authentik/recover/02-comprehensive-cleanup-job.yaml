apiVersion: batch/v1
kind: Job
metadata:
  name: comprehensive-cleanup-zalando
  namespace: auth
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 26
        runAsGroup: 26
        fsGroup: 26
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: cleanup
        image: busybox
        command:
        - sh
        - -c
        - |
          set -e

          echo "=== COMPREHENSIVE ZALANDO/PATRONI CLEANUP ==="
          echo "This job removes ALL Zalando/Patroni artifacts to ensure CNPG can bootstrap successfully"
          echo ""

          # Step 0: Restructure data directory if needed (Zalando -> CNPG)
          echo "=== Step 0: Checking and restructuring data directory ==="
          if [ -d /data/pgroot/data ] && [ ! -d /data/pgdata ]; then
            echo "⚠️  Zalando structure detected (/data/pgroot/data)"
            echo "Restructuring: moving pgroot/data to pgdata..."
            mv /data/pgroot/data /data/pgdata
            echo "✓ Data restructured to CNPG format"
          elif [ -d /data/pgdata ]; then
            echo "✓ CNPG structure already exists (/data/pgdata)"
          else
            echo "⚠️  WARNING: Neither pgroot/data nor pgdata found!"
            echo "Listing /data contents:"
            ls -la /data/
            exit 1
          fi

          # Remove any leftover pgroot directory (Zalando artifact)
          if [ -d /data/pgroot ] && [ -d /data/pgdata ]; then
            echo "⚠️  Removing leftover pgroot directory..."
            rm -rf /data/pgroot
            echo "✓ Removed leftover pgroot directory"
          fi

          cd /data/pgdata
          echo ""

          # Step 1: Remove Patroni-specific files
          echo "=== Step 1: Removing Patroni files ==="
          rm -f patroni.dynamic.json
          rm -f patroni.yml
          rm -f postgresql.base.conf
          rm -rf bootstrap 2>/dev/null || true
          echo "✓ Removed: patroni.dynamic.json, patroni.yml, postgresql.base.conf, bootstrap/"

          # Step 2: Remove recovery signal files (CNPG manages these automatically)
          echo ""
          echo "=== Step 2: Removing recovery signal files ==="
          rm -f recovery.signal
          rm -f standby.signal
          echo "✓ Removed: recovery.signal, standby.signal"

          # Step 3: Rewrite postgresql.conf cleanly for CNPG
          echo ""
          echo "=== Step 3: Rewriting postgresql.conf for CNPG compatibility ==="

          # Backup original
          cp postgresql.conf postgresql.conf.zalando-backup

          # Filter out Zalando/Patroni specific lines, preserve legitimate PostgreSQL settings
          # Also remove data_directory and hba_file that point to Zalando paths
          awk 'BEGIN {ORS=""} \
            /Do not edit this file manually/ { next } \
            /It will be overwritten by Patroni/ { next } \
            /include.*postgresql.base.conf/ { next } \
            /^cluster_name/ { next } \
            /^bg_mon\./ { next } \
            /^unix_socket_directories/ { next } \
            /^logging_collector/ { next } \
            /^log_destination/ { next } \
            /^log_directory/ { next } \
            /^ssl_cert_file/ { next } \
            /^ssl_key_file/ { next } \
            /^ssl_ca_file/ { next } \
            /^ssl[[:space:]]*=[[:space:]]*on/ { next } \
            /^data_directory.*pgroot/ { next } \
            /^hba_file.*pgroot/ { next } \
            { print $0 "\n" }' postgresql.conf.zalando-backup | \
          sed 's/bg_mon,//g; s/,bg_mon//g; s/bg_mon//g' > postgresql.conf.clean

          # Create clean CNPG-compatible postgresql.conf
          {
            echo "# PostgreSQL configuration - cleaned for CNPG compatibility"
            echo "# Zalando/Patroni artifacts removed"
            echo "# CNPG will append its fixed parameters at the end"
            echo ""
            echo "# CNPG-compatible temporary settings (CNPG will override with fixed parameters)"
            echo "unix_socket_directories = '/controller/run'"
            echo "logging_collector = off"
            echo "log_destination = 'stderr'"
            echo "ssl = off"
            echo ""
          } > postgresql.conf

          # Append preserved legitimate PostgreSQL settings
          if [ -s postgresql.conf.clean ]; then
            echo "" >> postgresql.conf
            echo "# Preserved legitimate PostgreSQL settings" >> postgresql.conf
            cat postgresql.conf.clean >> postgresql.conf
          fi

          # Clean up temp file
          rm -f postgresql.conf.clean

          echo "✓ postgresql.conf rewritten for CNPG compatibility"
          echo "  - Removed all Zalando/Patroni artifacts"
          echo "  - Set CNPG-compatible temporary paths"
          echo "  - Preserved legitimate PostgreSQL settings"
          echo "  - Backup saved as: postgresql.conf.zalando-backup"

          # Step 4: Fix pg_ident.conf for CNPG peer authentication
          echo ""
          echo "=== Step 4: Fixing pg_ident.conf for CNPG authentication ==="

          # Backup pg_ident.conf
          if [ -f pg_ident.conf ]; then
            cp pg_ident.conf pg_ident.conf.zalando-backup

            # Ensure local postgres->postgres mapping exists (required for CNPG peer auth)
            if ! grep -q "^local[[:space:]]*postgres[[:space:]]*postgres" pg_ident.conf; then
              echo "Adding local postgres->postgres mapping to pg_ident.conf..."
              # Insert before USER-DEFINED RULES section if it exists, otherwise at end
              if grep -q "^# USER-DEFINED RULES" pg_ident.conf; then
                awk '/^# USER-DEFINED RULES/ {print "local postgres postgres"}1' pg_ident.conf > pg_ident.conf.tmp
              else
                echo "local postgres postgres" >> pg_ident.conf
                cp pg_ident.conf pg_ident.conf.tmp
              fi
              mv pg_ident.conf.tmp pg_ident.conf
              echo "✓ Added local postgres->postgres mapping"
            else
              echo "✓ Local postgres->postgres mapping already exists"
            fi

            echo "Current pg_ident.conf local mappings:"
            grep "^local" pg_ident.conf || echo "  (none found)"
          else
            echo "⚠️  pg_ident.conf not found (will be created by CNPG)"
          fi

          echo ""
          echo "Note: Configuration file management:"
          echo "  postgresql:"
          echo "    pg_hba:"
          echo "      - local all all trust  # For recovery phase (MUST be in Cluster spec)"
          echo "  See: https://cloudnative-pg.io/documentation/current/postgresql_conf"
          echo ""
          echo "⚠️  IMPORTANT: This manual pg_ident.conf fix is a one-time operation for recovery."
          echo "   CNPG automatically adds the fixed rule: 'local <postgres system user> postgres'"
          echo "   No pg_ident section needed in Cluster spec unless custom mappings are required."

          # Step 4.5: Fix permissions (critical for PostgreSQL to start)
          echo ""
          echo "=== Step 4.5: Fixing permissions ==="

          # Fix ownership: postgres user (UID 26) and group (GID 26)
          echo "Setting ownership to postgres:postgres (26:26)..."
          chown -R 26:26 /data/pgdata

          # Fix directory permissions: 700 (drwx------) for directories
          echo "Setting directory permissions to 700..."
          find /data/pgdata -type d -exec chmod 700 {} \;

          # Fix file permissions: 600 (rw-------) for regular files
          echo "Setting file permissions to 600..."
          find /data/pgdata -type f -exec chmod 600 {} \;

          # Ensure pgdata directory itself has correct permissions
          chmod 700 /data/pgdata

          echo "✓ Permissions fixed:"
          echo "  - Ownership: 26:26 (postgres:postgres)"
          echo "  - Directories: 700 (drwx------)"
          echo "  - Files: 600 (rw-------)"

          # Step 5: Verification
          echo ""
          echo "=== Step 5: Verification ==="

          echo "Checking pg_ident.conf configuration:"
          if [ -f pg_ident.conf ]; then
            if grep -q "^local[[:space:]]*postgres[[:space:]]*postgres" pg_ident.conf; then
              echo "✓ pg_ident.conf has correct local postgres->postgres mapping"
            else
              echo "⚠️  WARNING: pg_ident.conf missing local postgres->postgres mapping"
            fi
          else
            echo "⚠️  pg_ident.conf not found (will be created by CNPG)"
          fi

          echo ""
          echo "Checking for remaining Patroni files:"
          REMAINING_PATRONI=$(ls -la patroni* postgresql.base.conf bootstrap/ 2>&1 | grep -v "No such file" | wc -l || echo "0")
          if [ "$REMAINING_PATRONI" = "0" ] || [ -z "$(ls -A patroni* postgresql.base.conf bootstrap/ 2>/dev/null)" ]; then
            echo "✓ No Patroni files remaining"
          else
            echo "WARNING: Some Patroni files may still exist"
            ls -la patroni* postgresql.base.conf bootstrap/ 2>&1 | grep -v "No such file" || true
          fi

          echo ""
          echo "Checking for recovery signal files:"
          if [ ! -f recovery.signal ] && [ ! -f standby.signal ]; then
            echo "✓ No recovery signal files"
          else
            echo "WARNING: Recovery signal files may still exist"
            ls -la recovery.signal standby.signal 2>&1 || true
          fi

          echo ""
          echo "Checking postgresql.conf for Patroni references:"
          if ! grep -q "postgresql.base.conf" postgresql.conf && ! grep -q "cluster_name" postgresql.conf && ! grep -q "bg_mon" postgresql.conf; then
            echo "✓ No Patroni references in postgresql.conf"
          else
            echo "WARNING: Patroni references may still exist:"
            grep -i "postgresql.base.conf\|cluster_name\|bg_mon" postgresql.conf || true
          fi

          echo ""
          echo "Checking SSL settings:"
          SSL_SETTING=$(grep -i "^ssl[[:space:]]*=" postgresql.conf | head -1 || echo "")
          if echo "$SSL_SETTING" | grep -qi "off"; then
            echo "✓ SSL is set to off"
          else
            echo "Current SSL setting: $SSL_SETTING"
            echo "WARNING: SSL may not be properly disabled"
          fi

          echo ""
          echo "=== COMPREHENSIVE CLEANUP COMPLETE ==="
          echo "All Zalando/Patroni artifacts have been removed."
          echo "The PVC is now ready for CNPG bootstrap."
        volumeMounts:
        - name: data
          mountPath: /data
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: authentik-postgresql-source
