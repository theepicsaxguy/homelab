---
apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: cloudflared-config
  namespace: cloudflared
spec:
  refreshInterval: 1h
  secretStoreRef:
    kind: ClusterSecretStore
    name: bitwarden-backend
  target:
    name: cloudflared-config
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        config.yaml: |
          tunnel: {{ .tunnelName }}
          credentials-file: /etc/cloudflared/credentials/credentials.json
          metrics: 0.0.0.0:2000
          no-autoupdate: true

          warp-routing:
            enabled: true

          ingress:

            - hostname: ittools.{{ .baseDomain }}
              service: https://cilium-gateway-external.gateway.svc.kube.{{ .baseDomain }}:443
            - hostname: argocd.{{ .baseDomain }}
              service: https://cilium-gateway-external.gateway.svc.kube.{{ .baseDomain }}:443
            - hostname: "*.{{ .baseDomain }}"
              service: https://cilium-gateway-external.gateway.svc.kube.{{ .baseDomain }}:443
              originRequest:
                originServerName: "*.{{ .baseDomain }}"
            - hostname: {{ .baseDomain }}
              service: https://cilium-gateway-external.gateway.svc.kube.{{ .baseDomain }}:443
              originRequest:
                originServerName: {{ .baseDomain }}
            - service: http_status:404
  data:
    - secretKey: tunnelName
      remoteRef:
        key: infra-cloudflared-tunnel-name
    - secretKey: baseDomain
      remoteRef:
        key: infra-cloudflared-base-domain
