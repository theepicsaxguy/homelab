# k8s/infrastructure/cronjobs/containerd-snapshot-gc/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: containerd-snapshot-gc
  namespace: kube-system
spec:
  selector:
    matchLabels:
      app: containerd-snapshot-gc
  template:
    metadata:
      labels:
        app: containerd-snapshot-gc
    spec:
      hostPID: true
      hostNetwork: true
      hostIPC: true
      restartPolicy: Always
      volumes:
        - name: lib-containerd
          hostPath:
            path: /var/lib/containerd
            type: Directory
      containers:
        - name: gc
          image: alpine:3.18
          securityContext:
            runAsUser: 0
          volumeMounts:
            - name: lib-containerd
              mountPath: /var/lib/containerd
          command:
            - /bin/sh
          args:
            - -c
            - |
              # loop forever, prune at 03:00 each day
              while true; do
                now=$(date +%H:%M)
                if [ "$now" = "03:00" ]; then
                  ctr -n k8s.io snapshots prune
                fi
                sleep 60
              done
