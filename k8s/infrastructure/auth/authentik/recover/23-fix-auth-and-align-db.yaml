# PREREQUISITE: The CNPG Cluster must have enableSuperuserAccess: true
# This Job uses 'psql -U postgres' which requires superuser access.
# Without enableSuperuserAccess, the postgres user has no password and
# peer authentication will fail.
---
apiVersion: batch/v1
kind: Job
metadata:
  name: fix-auth-and-align-db
  namespace: auth
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 26
        runAsGroup: 26
        fsGroup: 26
        seccompProfile:
          type: RuntimeDefault
      serviceAccountName: default
      containers:
      - name: fix
        image: ghcr.io/cloudnative-pg/postgresql:17
        command:
        - bash
        - -c
        - |
          set -e
          echo "=== FIXING AUTHENTICATION AND ALIGNING DATABASE ==="

          PGDATA=/data/pgdata

          # Get CNPG secret values
          APP_USER=$(kubectl get secret authentik-postgresql-app -n auth -o jsonpath='{.data.username}' | base64 -d)
          APP_PASSWORD=$(kubectl get secret authentik-postgresql-app -n auth -o jsonpath='{.data.password}' | base64 -d)
          APP_DB=$(kubectl get secret authentik-postgresql-app -n auth -o jsonpath='{.data.dbname}' | base64 -d)

          echo "CNPG expects:"
          echo "  User: $APP_USER"
          echo "  Database: $APP_DB"
          echo ""

          echo "=== Step 1: Checking current pg_hba.conf and pg_ident.conf ==="
          echo "pg_hba.conf local rules:"
          grep "^local" "$PGDATA/pg_hba.conf" || echo "No local rules found"

          echo ""
          echo "pg_ident.conf:"
          cat "$PGDATA/pg_ident.conf"

          echo ""
          echo "=== Step 2: Ensuring pg_ident.conf has correct mapping ==="
          # Backup files
          cp "$PGDATA/pg_hba.conf" "$PGDATA/pg_hba.conf.backup-$(date +%s)"
          cp "$PGDATA/pg_ident.conf" "$PGDATA/pg_ident.conf.backup-$(date +%s)"

          # Ensure local map has postgres->postgres mapping (should already exist, but verify)
          if ! grep -q "^local[[:space:]]*postgres[[:space:]]*postgres" "$PGDATA/pg_ident.conf"; then
            echo "Adding postgres->postgres mapping to pg_ident.conf..."
            # Insert before USER-DEFINED RULES using printf to avoid YAML multiline issues
            TEMP_FILE=$(mktemp)
            awk '/^# USER-DEFINED RULES/ {print "local postgres postgres"}1' "$PGDATA/pg_ident.conf" > "$TEMP_FILE" && mv "$TEMP_FILE" "$PGDATA/pg_ident.conf"
            echo "✓ Mapping added"
          else
            echo "✓ Mapping already exists in pg_ident.conf"
          fi

          echo ""
          echo "=== Step 3: Temporarily enabling trust auth for local connections ==="
          # Add trust rule BEFORE peer rule (PostgreSQL uses first match)
          # This allows us to connect and fix the database
          if ! grep -q "^# Temporary trust rule for recovery" "$PGDATA/pg_hba.conf"; then
            TEMP_FILE=$(mktemp)
            awk '/^# Grant local access/ {print "# Temporary trust rule for recovery fix"; print "local all all trust"}1' "$PGDATA/pg_hba.conf" > "$TEMP_FILE" && mv "$TEMP_FILE" "$PGDATA/pg_hba.conf"
            echo "✓ Added temporary trust rule"
          else
            echo "✓ Trust rule already exists"
          fi

          echo ""
          echo "=== Step 4: Verifying configuration ==="
          echo "Updated pg_hba.conf local rules:"
          grep "^local" "$PGDATA/pg_hba.conf"

          echo ""
          echo "Updated pg_ident.conf:"
          grep "^local" "$PGDATA/pg_ident.conf" || echo "No local mappings"

          echo ""
          echo "=== Step 5: Testing connection ==="
          export PGHOST=/controller/run
          if psql -U postgres -d postgres -c "SELECT version();" 2>&1; then
            echo "✓ Can connect to PostgreSQL"
          else
            echo "⚠️  Cannot test connection (PostgreSQL may need restart)"
            echo "Configuration files have been updated. PostgreSQL must be restarted for changes to take effect."
          fi

          echo ""
          echo "=== Step 6: Aligning database with CNPG secret ==="
          # Try to connect and fix database (will work after restart)
          if psql -U postgres -d postgres -c "SELECT version();" 2>&1 >/dev/null; then
            echo "Database exists check:"
            DB_EXISTS=$(psql -U postgres -d postgres -t -c "SELECT 1 FROM pg_database WHERE datname='$APP_DB';" 2>/dev/null | xargs || echo "0")

            if [ "$DB_EXISTS" != "1" ]; then
              echo "Creating database $APP_DB..."
              psql -U postgres -d postgres -c "CREATE DATABASE $APP_DB;" 2>&1 || echo "Failed to create database"
            fi

            USER_EXISTS=$(psql -U postgres -d postgres -t -c "SELECT 1 FROM pg_roles WHERE rolname='$APP_USER';" 2>/dev/null | xargs || echo "0")
            if [ "$USER_EXISTS" != "1" ]; then
              echo "Creating user $APP_USER..."
              psql -U postgres -d postgres -c "CREATE USER $APP_USER WITH PASSWORD '$APP_PASSWORD';" 2>&1 || echo "Failed to create user"
            else
              echo "Updating password for user $APP_USER..."
              psql -U postgres -d postgres -c "ALTER USER $APP_USER WITH PASSWORD '$APP_PASSWORD';" 2>&1 || echo "Failed to update password"
            fi

            psql -U postgres -d postgres -c "ALTER DATABASE $APP_DB OWNER TO $APP_USER;" 2>&1 || echo "Failed to set owner"
            psql -U postgres -d postgres -c "GRANT ALL PRIVILEGES ON DATABASE $APP_DB TO $APP_USER;" 2>&1 || echo "Failed to grant privileges"
            psql -U postgres -d "$APP_DB" -c "GRANT ALL ON SCHEMA public TO $APP_USER;" 2>&1 || echo "Failed to grant schema privileges"

            echo "✓ Database alignment attempted (may need pod restart to complete)"
          else
            echo "⚠️  Cannot connect now - database alignment will happen after pod restart"
            echo "After pod restart, run the alignment script: 22-align-database-script.sh"
          fi

          echo ""
          echo "=== FIX COMPLETE ==="
          echo "Configuration files updated:"
          echo "  - pg_hba.conf: Added temporary trust rule for local connections"
          echo "  - pg_ident.conf: Verified postgres->postgres mapping"
          echo ""
          echo "⚠️  IMPORTANT: PostgreSQL must be restarted for pg_hba.conf changes to take effect."
          echo "Delete the pod to trigger restart:"
          echo "  kubectl delete pod authentik-postgresql-1 -n auth"
          echo ""
          echo "After restart, CNPG should be able to connect via peer authentication."
        volumeMounts:
        - name: data
          mountPath: /data
        - name: controller-run
          mountPath: /controller/run
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: authentik-postgresql-1
      - name: controller-run
        emptyDir: {}

