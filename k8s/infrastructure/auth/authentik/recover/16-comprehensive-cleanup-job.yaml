apiVersion: batch/v1
kind: Job
metadata:
  name: comprehensive-cleanup-zalando
  namespace: auth
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 26
        runAsGroup: 26
        fsGroup: 26
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: cleanup
        image: busybox
        command:
        - sh
        - -c
        - |
          set -e

          echo "=== COMPREHENSIVE ZALANDO/PATRONI CLEANUP ==="
          echo "This job removes ALL Zalando/Patroni artifacts to ensure CNPG can bootstrap successfully"
          echo ""

          # Step 0: Restructure data directory if needed (Zalando -> CNPG)
          echo "=== Step 0: Checking and restructuring data directory ==="
          if [ -d /data/pgroot/data ] && [ ! -d /data/pgdata ]; then
            echo "⚠️  Zalando structure detected (/data/pgroot/data)"
            echo "Restructuring: moving pgroot/data to pgdata..."
            mv /data/pgroot/data /data/pgdata
            echo "✓ Data restructured to CNPG format"
          elif [ -d /data/pgdata ]; then
            echo "✓ CNPG structure already exists (/data/pgdata)"
          else
            echo "⚠️  WARNING: Neither pgroot/data nor pgdata found!"
            echo "Listing /data contents:"
            ls -la /data/
            exit 1
          fi

          cd /data/pgdata
          echo ""

          # Step 1: Remove Patroni-specific files
          echo "=== Step 1: Removing Patroni files ==="
          rm -f patroni.dynamic.json
          rm -f patroni.yml
          rm -f postgresql.base.conf
          rm -rf bootstrap 2>/dev/null || true
          echo "✓ Removed: patroni.dynamic.json, patroni.yml, postgresql.base.conf, bootstrap/"

          # Step 2: Remove recovery signal files (CNPG manages these automatically)
          echo ""
          echo "=== Step 2: Removing recovery signal files ==="
          rm -f recovery.signal
          rm -f standby.signal
          echo "✓ Removed: recovery.signal, standby.signal"

          # Step 3: Clean postgresql.conf - Remove Patroni-specific settings
          echo ""
          echo "=== Step 3: Cleaning postgresql.conf ==="

          # Remove Patroni comments
          sed -i '/# Do not edit this file manually!/d' postgresql.conf
          sed -i '/# It will be overwritten by Patroni!/d' postgresql.conf

          # Remove include statement for postgresql.base.conf
          sed -i "/include 'postgresql.base.conf'/d" postgresql.conf
          sed -i '/include "postgresql.base.conf"/d' postgresql.conf

          # Remove cluster_name (Patroni-specific)
          sed -i '/^cluster_name/d' postgresql.conf

          # Remove bg_mon extension settings
          sed -i '/^bg_mon\./d' postgresql.conf

          # Remove bg_mon from shared_preload_libraries (all variations)
          sed -i "s/shared_preload_libraries = 'bg_mon'/# shared_preload_libraries = 'bg_mon' # Removed Zalando extension/" postgresql.conf
          sed -i "s/shared_preload_libraries = \"bg_mon\"/# shared_preload_libraries = \"bg_mon\" # Removed Zalando extension/" postgresql.conf
          sed -i "/^shared_preload_libraries.*bg_mon/s/^/# /" postgresql.conf
          # Handle comma-separated lists
          sed -i "s/bg_mon,//g" postgresql.conf
          sed -i "s/,bg_mon//g" postgresql.conf
          sed -i "s/'bg_mon'//g" postgresql.conf
          sed -i "s/\"bg_mon\"//g" postgresql.conf

          echo "✓ Removed Patroni-specific settings from postgresql.conf"

          # --- CRITICAL FIXES FOR CNPG COMPATIBILITY ---
          echo ""
          echo "=== Step 3.5: Applying CNPG-specific path fixes ==="

          # 1. Fix Socket Directory (Zalando: /var/run/postgresql -> CNPG: /controller/run)
          # Remove any existing unix_socket_directories setting
          sed -i '/^unix_socket_directories/d' postgresql.conf
          # Append the correct setting (CNPG's fixed parameter)
          echo "unix_socket_directories = '/controller/run'" >> postgresql.conf

          # 2. Fix Logging (CNPG requires specific paths; disable collector for migration safety)
          # Remove any existing logging_collector setting
          sed -i '/^logging_collector/d' postgresql.conf
          # Disable the collector (CNPG will re-enable with correct path later)
          echo "logging_collector = off" >> postgresql.conf

          # 3. Set log destination to stderr (so we can see logs via kubectl)
          # Remove any existing log_destination setting
          sed -i '/^log_destination/d' postgresql.conf
          echo "log_destination = 'stderr'" >> postgresql.conf

          # 4. Comment out log_directory (in case it's set to invalid path)
          sed -i 's/^log_directory/# log_directory # CNPG manages this/' postgresql.conf

          echo "✓ Applied CNPG compatibility fixes:"
          echo "  - unix_socket_directories = '/controller/run'"
          echo "  - logging_collector = off"
          echo "  - log_destination = 'stderr'"
          # -------------------------------------------------

          # Step 4: Fix SSL configuration (CNPG manages SSL differently)
          echo ""
          echo "=== Step 4: Fixing SSL configuration ==="

          # Comment out SSL certificate file references
          sed -i 's/^ssl_cert_file/# ssl_cert_file # Removed for CNPG/' postgresql.conf
          sed -i 's/^ssl_key_file/# ssl_key_file # Removed for CNPG/' postgresql.conf
          sed -i 's/^ssl_ca_file/# ssl_ca_file # Removed for CNPG/' postgresql.conf

          # Ensure SSL is off (CNPG will manage SSL if needed)
          sed -i 's/^ssl = on/ssl = off/' postgresql.conf
          sed -i "s/^ssl = 'on'/ssl = 'off'/" postgresql.conf
          sed -i "s/^ssl = \"on\"/ssl = \"off\"/" postgresql.conf

          echo "✓ SSL configuration fixed"

          # Step 5: Verification
          echo ""
          echo "=== Step 5: Verification ==="

          echo "Checking for remaining Patroni files:"
          REMAINING_PATRONI=$(ls -la patroni* postgresql.base.conf bootstrap/ 2>&1 | grep -v "No such file" | wc -l || echo "0")
          if [ "$REMAINING_PATRONI" = "0" ] || [ -z "$(ls -A patroni* postgresql.base.conf bootstrap/ 2>/dev/null)" ]; then
            echo "✓ No Patroni files remaining"
          else
            echo "WARNING: Some Patroni files may still exist"
            ls -la patroni* postgresql.base.conf bootstrap/ 2>&1 | grep -v "No such file" || true
          fi

          echo ""
          echo "Checking for recovery signal files:"
          if [ ! -f recovery.signal ] && [ ! -f standby.signal ]; then
            echo "✓ No recovery signal files"
          else
            echo "WARNING: Recovery signal files may still exist"
            ls -la recovery.signal standby.signal 2>&1 || true
          fi

          echo ""
          echo "Checking postgresql.conf for Patroni references:"
          if ! grep -q "postgresql.base.conf" postgresql.conf && ! grep -q "cluster_name" postgresql.conf && ! grep -q "bg_mon" postgresql.conf; then
            echo "✓ No Patroni references in postgresql.conf"
          else
            echo "WARNING: Patroni references may still exist:"
            grep -i "postgresql.base.conf\|cluster_name\|bg_mon" postgresql.conf || true
          fi

          echo ""
          echo "Checking SSL settings:"
          SSL_SETTING=$(grep -i "^ssl[[:space:]]*=" postgresql.conf | head -1 || echo "")
          if echo "$SSL_SETTING" | grep -qi "off"; then
            echo "✓ SSL is set to off"
          else
            echo "Current SSL setting: $SSL_SETTING"
            echo "WARNING: SSL may not be properly disabled"
          fi

          echo ""
          echo "=== COMPREHENSIVE CLEANUP COMPLETE ==="
          echo "All Zalando/Patroni artifacts have been removed."
          echo "The PVC is now ready for CNPG bootstrap."
        volumeMounts:
        - name: data
          mountPath: /data
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: authentik-postgresql-source
