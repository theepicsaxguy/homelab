apiVersion: batch/v1
kind: CronJob
metadata:
  name: containerd-snapshot-gc
  namespace: kube-system # Assuming this runs in kube-system
spec:
  schedule: "15 2 * * *" # Run daily at 2:15 AM
  jobTemplate:
    spec:
      template:
        spec:
          serviceAccountName: containerd-snapshot-gc
          # Add tolerations to allow running on control-plane nodes
          tolerations:
          - key: node-role.kubernetes.io/control-plane
            operator: Exists
            effect: NoSchedule
          - key: node-role.kubernetes.io/master
            operator: Exists
            effect: NoSchedule
          containers:
          - name: containerd-snapshot-gc
            # Replace with the actual digest you provide
            image: ghcr.io/containerd/ctr@sha256:<exact-digest-for-1.7.13>
            command: ["/bin/sh", "-c"]
            args:
            - |
              set -euo pipefail
              echo "Running containerd garbage collection..."
              # The command to trigger GC via the socket
              ctr -a /run/containerd/containerd.sock content garbage-collect
              echo "Containerd garbage collection complete."
            resources:
              requests:
                cpu: 50m
                memory: 64Mi
              limits:
                cpu: 100m
                memory: 128Mi
            securityContext:
              # Harden security context
              runAsUser: 0 # Required to access /run/containerd/containerd.sock by default
              privileged: false
              allowPrivilegeEscalation: false
              capabilities:
                drop: ["ALL"]
            volumeMounts:
            - name: containerd-socket
              mountPath: /run/containerd/containerd.sock
          volumes:
          - name: containerd-socket
            hostPath:
              path: /run/containerd/containerd.sock
              type: Socket # Ensure the socket exists at this path on the node
          restartPolicy: OnFailure
          # Add nodeSelector or tolerations if needed to ensure it runs on appropriate nodes
          # nodeSelector:
          #   kubernetes.io/os: linux
