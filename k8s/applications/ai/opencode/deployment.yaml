apiVersion: apps/v1  
kind: Deployment  
metadata:  
  name: opencode-web  
  namespace: opencode  
  labels:  
    app: opencode-web  
spec:  
  replicas: 1  
  strategy:
    type: Recreate
  selector:  
    matchLabels:  
      app: opencode-web  
  template:  
    metadata:  
      labels:  
        app: opencode-web  
    spec:
      securityContext:
        runAsNonRoot: false
        fsGroup: 1000
        fsGroupChangePolicy: OnRootMismatch
        seccompProfile:
          type: RuntimeDefault
      initContainers:
        - name: installer
          image: mcr.microsoft.com/playwright:v1.58.2-jammy
          imagePullPolicy: IfNotPresent
          command: ["/bin/sh", "-c"]
          args:
            - |
              mkdir -p /shared/bin /shared/.cache
              wget -q -O /shared/bin/kustomize https://github.com/kubernetes-sigs/kustomize/releases/download/kustomize%2Fv5.4.1/kustomize_v5.4.1_linux_amd64
              chmod +x /shared/bin/kustomize
              cp -a /ms-playwright/. /shared/.cache/ms-playwright/
          securityContext:
            runAsUser: 0
            runAsNonRoot: false
            capabilities:
              drop: ["ALL"]
          volumeMounts:
            - name: shared-tools
              mountPath: /shared
      containers:
      - name: opencode-web
        image: ghcr.io/chriswritescode-dev/opencode-manager:0.9.0
        securityContext:  
          runAsUser: 1000  
          runAsGroup: 1000  
          runAsNonRoot: true  
          allowPrivilegeEscalation: false  
          capabilities:  
            drop: ["ALL"]
        ports:
        - containerPort: 5003
        env:
        - name: OPENCODE_HOST
          value: "127.0.0.1"
        - name: AUTH_SECRET
          valueFrom:
            secretKeyRef:
              name: app-opencode-secrets
              key: AUTH_SECRET
        - name: VAPID_PUBLIC_KEY
          valueFrom:
            secretKeyRef:
              name: app-opencode-secrets
              key: VAPID_PUBLIC_KEY
        - name: VAPID_PRIVATE_KEY
          valueFrom:
            secretKeyRef:
              name: app-opencode-secrets
              key: VAPID_PRIVATE_KEY
        - name: AUTH_TRUSTED_ORIGINS
          value: "https://opencode.peekoff.com,http://localhost:5003,http://10.0.10.*:5003"
        - name: AUTH_SECURE_COOKIES
          value: "true"
        - name: PATH
          value: "/shared/bin:/usr/local/bin:/usr/local/sbin:/usr/bin:/bin:/usr/local/bin"
        - name: PLAYWRIGHT_BROWSERS_PATH
          value: "/shared/.cache/ms-playwright"
        volumeMounts:  
        - name: workspace  
          mountPath: /workspace  
        - name: data  
          mountPath: /app/data
        - name: shared-tools
          mountPath: /shared
        livenessProbe:  
          httpGet:  
            path: /api/health  
            port: 5003  
          initialDelaySeconds: 40  
          periodSeconds: 30  
          timeoutSeconds: 30
          failureThreshold: 3
        readinessProbe:
          httpGet:
            path: /api/health
            port: 5003
          initialDelaySeconds: 15
          periodSeconds: 30
          timeoutSeconds: 30  
          failureThreshold: 5  
      volumes:
      - name: workspace
        persistentVolumeClaim:
          claimName: opencode-workspace-pvc
      - name: data
        persistentVolumeClaim:
          claimName: opencode-data-pvc
      - name: shared-tools
        emptyDir:
          sizeLimit: 3Gi
