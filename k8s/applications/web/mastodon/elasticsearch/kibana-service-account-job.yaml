apiVersion: batch/v1
kind: Job
metadata:
  name: kibana-service-account-setup
  namespace: mastodon
  annotations:
    helm.sh/hook: post-install,post-upgrade
    helm.sh/hook-weight: "6"
    helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
        - name: wait-for-elasticsearch
          image: curlimages/curl:8.15.0
          command:
            - sh
            - -c
            - |
              until curl -k -u "elastic:${ELASTIC_PASSWORD}" https://elasticsearch-master:9200/_cluster/health?wait_for_status=yellow&timeout=30s; do
                echo "Waiting for Elasticsearch to be ready..."
                sleep 10
              done
          env:
            - name: ELASTIC_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-credentials
                  key: elasticsearch-password
      containers:
        - name: setup-kibana-token
          image: curlimages/curl:8.15.0
          command:
            - sh
            - -c
            - |
              set -e
              echo "Creating Kibana service account token via REST API..."

              # Wait for Elasticsearch to be ready with authentication
              until curl -k -u "elastic:${ELASTICSEARCH_PASSWORD}" -s https://elasticsearch-master:9200/_cluster/health; do
                echo "Waiting for Elasticsearch..."
                sleep 10
              done

              # Create the service account token via REST API
              echo "Creating service account token..."
              TOKEN_RESPONSE=$(curl -k -u "elastic:${ELASTICSEARCH_PASSWORD}" -X POST \
                "https://elasticsearch-master:9200/_security/service/elastic/kibana/credential/token/kibana-token" \
                -H 'Content-Type: application/json' \
                -s)

              echo "Token creation response: $TOKEN_RESPONSE"

              # Extract the token value
              TOKEN=$(echo "$TOKEN_RESPONSE" | grep -o '"value":"[^"]*"' | cut -d'"' -f4)

              if [[ -n "$TOKEN" ]]; then
                echo "Service account token created successfully"
                echo "Token should be stored in Bitwarden under key: app-mastodon-elasticsearch-kibana-token"
                echo "Token value: $TOKEN"
              else
                echo "Token creation failed or token already exists"
                echo "Response: $TOKEN_RESPONSE"
              fi
          env:
            - name: ELASTICSEARCH_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: elasticsearch-credentials
                  key: elasticsearch-password
          volumeMounts:
            - name: elasticsearch-certs
              mountPath: /opt/bitnami/elasticsearch/config/certs
              readOnly: true
      volumes:
        - name: elasticsearch-certs
          secret:
            secretName: mastodon-elastic-server
