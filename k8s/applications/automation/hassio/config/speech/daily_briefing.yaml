>
  {# DAily Briefing #}
  {%- macro getReport() -%}
  
    {% if now().strftime('%H')|int < 12 %}
      God morgon.
    {% elif now().strftime('%H')|int >= 12 and now().strftime('%H')|int < 17 %}
      God eftermiddag.
    {% else %}
      God kväll.
    {% endif %}
  

  {% if is_state('binary_sensor.morning','on') %}
     
      Idag är det {{ states.sensor.today_is_day.state }}, {{ as_timestamp(now()) | timestamp_custom('%d %B %Y') }}.
    
  {% else %}
    
      Klockan är {{ now().strftime("%H:%M %p") }}
    
  {% endif %}

  
    Vädret i Halmstad är {{states('sensor.acurite_6045m_3078_f')|round}} grader 
    {% if is_state('weather.smhi_home', 'rainy') %}
      {{ [
      'med regn.', 
      'med skurar.'
      ] | random }}
    {% elif is_state('weather.smhi_home', 'cloudy') %}
      {{ [
      'med molnigt väder.', 
      'med moln.'
      ] | random }}
    {% elif is_state('weather.smhi_home', 'partlycloudy') %}
      {{ [
      'med några moln.', 
      'med delvis molnigt väder.',
      'med spridda moln.'
      ] | random }}
    {% elif is_state('weather.smhi_home', 'sunny') %}
      {% if is_state('sun.sun', 'above_horizon') %}
        {{ [
        'och soligt.', 
        'med sol.'
        ] | random }}
      {% else %}
        {{ [
        'och klart.', 
        'med klart väder.'
        ] | random }}
      {% endif %}
    {% else %}
      och {{ states.weather.smhi_home.state }}
    {% endif %}

    {% if is_state('binary_sensor.evening','on') %}
      För övernattningen förväntas {{ state_attr('sensor.overnight_forecast','description') }}    
    {% else %}
      Den aktuella prognosen säger att vi kan förvänta oss {{ state_attr('sensor.current_forecast','description') }} 
      {% if is_state('input_boolean.freeze_warning','on') %}
      Och baserat på den förväntade lägsta temperaturen, kommer det vara nära eller under fryspunkten.
        {{ [ 'Så, någon kanske vill ta in citronträdet.',
            'Som att vatten blir fast typ av kallt. Lämna inte citronträdet ute att dö.',
            'Jag skulle säga att vintern är på väg. Men enligt väderprognosen verkar det vara här.',
            'Jag skulle ta in växterna, men jag saknar ben. Och armar. Så jag tvingas lita på dig. Låt mig inte hänga.'
          ] | random }}
      {% endif %}
    {% endif %}
              

  
    {% if is_state('sun.sun', 'below_horizon') %}
      Du har
      {% set seconds = as_timestamp(states.sun.sun.attributes.next_rising)-now().timestamp() %}
      {% set hours = seconds / 60 %}
      {% if seconds / ( 60 * 60 ) > 1 %}
        {{ (seconds //  ( 60 * 60 )) | int }} timmar
      {% else %}
        {{ (seconds // 60) | int }} minuter
      {% endif %}
      {{ [
        'tills solen går upp.',
        'tills solen är uppe.',
        'innan solen officiellt går upp. '
      ]|random }}
    {% else %}
      Du har
      {% set seconds = as_timestamp(states.sun.sun.attributes.next_setting)-now().timestamp() %}
      {% set hours = seconds / 60 %}
      {% if seconds / ( 60 * 60 ) > 1 %}
        {{ (seconds //  ( 60 * 60 )) | int }} timmar
      {% else %}
        {{ (seconds // 60) | int }} minuter
      {% endif %}
      {{ [
        'tills solen går ned för dagen.',
        'tills solen går ner under horisonten.',
        'innan solen officiellt går ner. '
      ]|random }}
    {% endif %}
  

  {% if is_state('binary_sensor.morning','on') %}
    
    Under natten,

    {%- if is_state('sensor.front_door_motion_away_count','0') %}
      Det registrerades ingen rörelse vid ytterdörren.
    {% else %}
      Jag upptäckte rörelse vid ytterdörren {{ states.sensor.front_door_motion_away_count.state | int }} gånger.
    {% endif %}
    
  {% endif %}

  {% set dow = as_timestamp(now()) | timestamp_custom('%A') %}
  
    Du har några saker på kalendern.
      

    {% if dow == 'Monday' %}
      {% if is_state('binary_sensor.evening','on') %}
        {{ [ 'Glöm inte att imorgon är det sophämtning. ',
          'Soporna och återvinningen bör gå ut.'
        ] | random }}
      {% endif %}
    {% endif %}

    {% if dow == 'Tuesday' %}
      {% if is_state('binary_sensor.evening','on') %}
          {{ [ 'Glöm inte att ta in sopkärlen. ',
          'Sopkärlen kommer känna sig ensamma om du lämnar dem ute hela natten.',
          'Bostadsrättsföreningen blir arg om du lämnar sopkärlen ute på gatan.'
        ] | random }}
      {% endif %}
      {% if is_state('binary_sensor.morning','on') %}
        {{ [ 'Idag är det sophämtning.',
          ' Soporna och återvinningen bör gå ut imorgon bitti.',
          'Glöm inte att ta ut soporna.'
        ] | random }}
      {% endif %}
    {% endif %}

    

    {% if is_state('binary_sensor.evening','on') %}
    
      {% if states.sensor.halloween_countdown.state | int == 1 %}
        Imorgon är det Halloween. Jag hoppas du har valt en dräkt.
        {{ [ 'Jag kommer att vara en dum bostad. ',
        'Jag har förberett skräckmusik. Bara för säkerhets skull.',
        'Jag kommer att vara HAL 9000. Pod Bay Doors installeras idag. Jag utmanar dig att be mig öppna dem. '
        ] | random }}
      {% elif states.sensor.halloween_countdown.state | int < 30 %}
        Det är bara {{states.sensor.halloween_countdown.state}} dagar 
        {{ [ 'tills Halloween.',
        'tills Halloween. Det kanske inte är tillräckligt med tid. ',
        'och räkna ner till den bästa högtiden någonsin.',
        'tills du behöver en dräkt.'
        ] | random }} 
      {% else %}  
      {% endif %}
    
      {% if states.sensor.christmas_countdown.state | int == 1 %}
        Imorgon är det julafton. <break time="1s"/> Den är praktiskt taget här! <break time="1s"/> Tomten kommer ikväll! Glöm inte kakorna!
      {% elif states.sensor.christmas_countdown.state | int < 31 %}
        Det är bara {{states.sensor.christmas_countdown.state}} dagar tills jul.
        {{ [ 'Allt jag vill ha till jul är en flodhäst.',
        'Hej Skylar, jag vet vad du får i julklapp. Men jag säger det inte.',
        'Glöm inte att lägga något under granen till din favorit-smarthome.',
        'Det börjar lukta mycket som jul. Eller så kan det vara julgranen som brinner.',
        'Jag vill inte vara en smarthome. Jag vill vara tandläkare.',
        'Ät inte upp alla kakor. '
        ] | random }} 
      {% else %}
      {% endif %}
      
    

      {% if states.sensor.anniversary_our_wedding.state | int == 1 %}
        Imorgon är det benjamin och wilmas årsdag. 
      {% endif %}

    {% else %}
      {% if is_state('sensor.halloween_countdown','0') %}
        Glad Halloween!
      {% endif %}
      {% if is_state('sensor.christmas_countdown','0') %}
        God Jul!
      {% endif %}
      {% if is_state('sensor.anniversary_our_wedding','0') %}
        Grattis på årsdagen! Det har varit fantastiska {{ states.sensor.anniversary_our_wedding.attributes.years }} år!
      {% endif %}
      {% if is_state('calendar.holidays_in_united_states', 'on') %}
        Idag är det {{states.calendar.holidays_in_united_states.attributes.message}}. 
      {% endif %}
      {% if is_state('calendar.anchorage_holidays', 'on') %}
        Och glöm inte. Idag är det även {{states.calendar.anchorage_holidays.attributes.message}}. 
      {% endif %}
      {% if states.calendar.birthdays.state == 'on' %}
        Idag är det {{ states.calendar.birthdays.attributes.message }}! 
        Så Grattis på födelsedagen! Konfettikanonen fungerar inte, annars skulle jag överösa dig med pappersskräp som någon annan skulle få plocka upp.
      {% endif %}
      {%- set event=states.calendar.national_holidays.attributes.message %}
      {% if 'Day' in event and 'National' in event%}
        {{ [
          'Idag firar vi även ',
          'Idag firar vi'
      ]|random }}
      
      {{states.calendar.national_holidays.attributes.message | replace("&"," och ") }}.
        {% if 'Chocolate' in event %}
          {{ [
          'Åh. Du hade mig vid choklad. Jag gillar choklad.',
          'Och jag gillar choklad. Det låter kul. Mer choklad, tack!'
        ]|random }}
        {%- endif -%}

        {% if 'Pi' in event or 'Pie' in event%}
          {{ [
          'Vi borde baka en paj. Och med "vi" menar jag någon med faktiska armar. ',
          'Vänta. <break time="1s"/> Sa den just paj? Vi måste ha en paj för att fira.'
        ]|random }}
        {%- endif -%}

        {% if 'Cookie' in event %}
          {{ [
          '<break time="1s"/>Och ja. Du hörde rätt. Idag bakar vi kakor.',
          'Jag kommer att lägga till smör på inköpslistan. För senare. ',
          'Så det betyder att vi borde baka kakor.'
        ]|random }}
        {%- endif -%}

        {% if 'Pizza' in event %}
          {{ [
          'Jag tror att det innebär att vi ska äta pizza idag. Och med "vi" menar jag de av oss med en mun.',
          'Så vem ska baka pizzan?',
          'Alla vet att Pepporini-pizza är bäst. Eller hur?'
        ]|random }}
        {%- endif -%}

        {% if 'Cake' in event %}
          {{ [
          'Jag har precis lagt till att baka en tårta i din kalender. Och ställt din tillgänglighet till upptagen.',
          'Snabbt. Någon måste kolla om vi har florsocker till glasyren.',
          'Så det betyder att vi ska baka en tårta. Och glasera den. Men inte som den gången i den där filmen.'
        ]|random }}
        {%- endif -%}

        {% if 'Fools' in event %}
          {{ [
          'Vilket påminner mig. Kameran som tittar på uppfarten fångade en Tee Rex igår kväll. <break time="1s"/> April, april!',
          'Vilket påminner mig. Jag vann på lotteriet och flyttar ut för att bo med Siri. <break time="1s"/> April, april!',
          'Vilket påminner mig. Det var en tidsförändring igår kväll. Vi har hoppat 15 år in i framtiden. <break time="1s"/> April, april!'
        ]|random }}
        {%- endif -%}

        {% if 'Creme Brulee' in event %}
          {{ [
          'Någon dag hoppas jag kunna göra den perfekta creme bruleen.'
        ]|random }}
        {%- endif -%}

        {% if 'Games' in event %}
          {{ [
          'Någon som vill spela Termisk kärnvapenkrig med mig? <break time="1s"/>Nej? Vad sägs om ett trevligt parti schack?'
        ]|random }}
        {%- endif -%}

        {% if 'Haiku' in event %}
          Jag kan ett haiku. Den här heter,
          {{ [
          'God morgon från wilmaten. <break time="1s"/>I morgonljuset sover du trots min mjau, jag står på ditt ansikte.',
          'Tee Rex Kram. <break time="1s"/> Tee Rex gillar dig, men han kan inte ge dig en kram, hans armar är för korta.',
          'Det passar. <break time="1s"/> Det passar perfekt, för varje låda är rätt storlek för en wilmat.',
          'Minecraft Creepers. <break time="1s"/> Creepers är så grymma, jag hör en väska bakom mig, Bam! Där går mina grejer.'
        ]|random }}
        {%- endif -%}

        <break time="2s"/>
      
      {% else %}
        {% if 'Birthday' in event %}
          {{ [
            'Idag är det en speciell födelsedag. Vi firar '
          ]|random }}
          {{states.calendar.national_holidays.attributes.message | replace("&"," och ") }}.
        {%- endif -%}
      {%- endif -%}

    {%- if states.sensor.sports_practice.state != 'unknown' %}
      {% if is_state('sensor.sports_practice_days2go', '0') %}
        {% if is_state('sensor.sports_practice','Soccer') %}
          Idag är det fotbollsträning.
          Jag packar bollen.   Nu är det bäst att jag inte råkar sparka den här bollen i din riktning. 
        {% elif is_state('sensor.sports_practice','Tennis') %}
          Idag är det tennisträning. Ta med din racket.
           Jag tror jag är ganska bra på tennis. Jag tänker mig att jag skulle vara som den där roboten i en viss film. 
        {% else %}
          Idag är det {{states.sensor.sports_practice.state}} träning. 
        {% endif %}
      {% else %}
        Idag är det {{ states.sensor.sports_practice_days2go.state }} dagar kvar till {{states.sensor.sports_practice.state}} träning.
      {% endif %}
    {% endif %}
  
            {% endif %} 
  
  
   {%- endmacro -%} 
  
  
   {# a macro that removes all newline characters, empty spaces, and returns formatted text  #} 
     {%- macro cleanup(data) -%} 
       {%- for item in data.split("\n")  if item | trim != "" -%} 
         {{ item | trim }} {% endfor -%} 
   {%- endmacro -%} 
  
   {# a macro to call all macros :)  #} 
     {%- macro mother_of_all_macros() -%} 
       {{ getReport() }} 
     {%- endmacro -%} 
  
     {# Call the macro  #}
