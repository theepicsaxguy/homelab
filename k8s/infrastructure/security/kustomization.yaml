apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

resources:
# Gatekeeper v3.21.0 - NSA/CISA admission control (deploys to gatekeeper-system)
- https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.21.0/deploy/gatekeeper.yaml

# Kyverno v1.16.2 - Policy validation + mutation (deploys to kyverno)
- https://github.com/kyverno/kyverno/releases/download/v1.16.2/install.yaml

# Monitoring and secrets integration
- monitoring.yaml
- externalsecret.yaml  # Requires external-secrets CRDs

# Security policies (Gatekeeper/Kyverno applied separately after CRDs ready)
- policies/gatekeeper-policies.yaml  # Requires Gatekeeper CRDs
- policies/kyverno-policies.yaml  # Requires Kyverno CRDs
- policies/falco-custom-rules.yaml
- policies/kubearmor-policies.yaml

# Helm Charts - Falco and KubeArmor
helmCharts:
- name: falco
  namespace: security-system
  releaseName: falco
  repo: https://falcosecurity.github.io/charts
  valuesFile: falco-values.yaml
  version: 7.2.1

- name: kubearmor
  namespace: security-system
  releaseName: kubearmor
  repo: https://kubearmor.github.io/charts
  valuesFile: kubearmor-values.yaml
  version: 1.6.6

# Remove deprecated AppArmor annotations and ensure security contexts
patches:
- target:
    kind: DaemonSet
    name: falco
    namespace: security-system
  patch: |-
    - op: remove
      path: /spec/template/metadata/annotations/container.apparmor.security.beta.kubernetes.io~1falco
- target:
    kind: Deployment
    name: kubearmor
    namespace: security-system
  patch: |-
    - op: remove
      path: /spec/template/metadata/annotations/container.apparmor.security.beta.kubernetes.io~1kubearmor
