# Schema validation disabled - Authentik blueprints use custom YAML tags incompatible with JSON schema
# yamllint disable
# prettier-ignore
# eslint-disable
# yaml-language-server: $schema=https://goauthentik.io/blueprints/schema.json
---
version: 1
metadata:
  name: Flows - Passwordless Authentication
entries:
  # Create the passwordless authentication flow
  - id: flow-passwordless-auth
    model: authentik_flows.flow
    identifiers:
      slug: passwordless-authentication-flow
    attrs:
      name: Passwordless Authentication
      title: Sign in with passkey or biometric
      designation: authentication
      policy_engine_mode: all
      compatibility_mode: false
      layout: stacked

  # WebAuthn Authenticator Validation Stage
  - id: stage-webauthn-validation
    model: authentik_stages_authenticator_validate.authenticatorvalidatestage
    identifiers:
      name: passwordless-webauthn-validation
    attrs:
      device_classes:
        - webauthn  # Only allow WebAuthn devices (passkeys, security keys, biometrics)
      not_configured_action: deny  # Deny if user has no WebAuthn devices
      configuration_stages: []
      last_auth_threshold: "seconds=0"  # Always validate

  # User Login Stage
  - id: stage-user-login
    model: authentik_stages_user_login.userloginstage
    identifiers:
      name: passwordless-user-login
    attrs:
      session_duration: "seconds=0"
      remember_me_offset: "weeks=4"

  # Bind WebAuthn validation stage to flow (order 10)
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !KeyOf flow-passwordless-auth
      stage: !KeyOf stage-webauthn-validation
      order: 10
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
      policy_engine_mode: all
      invalid_response_action: retry

  # Bind user login stage to flow (order 20)
  - model: authentik_flows.flowstagebinding
    identifiers:
      target: !KeyOf flow-passwordless-auth
      stage: !KeyOf stage-user-login
      order: 20
    attrs:
      evaluate_on_plan: true
      re_evaluate_policies: false
      policy_engine_mode: all
      invalid_response_action: retry
