# k8s/infrastructure/cronjobs/containerd-snapshot-gc/daemonset.yaml
apiVersion: apps/v1
kind: DaemonSet
metadata:
  name: containerd-snapshot-gc
  namespace: kube-system
  labels:
    app.kubernetes.io/name: containerd-snapshot-gc
spec:
  selector:
    matchLabels:
      app.kubernetes.io/name: containerd-snapshot-gc
  template:
    metadata:
      labels:
        app.kubernetes.io/name: containerd-snapshot-gc
    spec:
      containers:
        - name: containerd-snapshot-gc
          # Using official ctr image
          image: ghcr.io/containerd/ctr:1.7.13
          # Run prune command in a loop (daily)
          command: ["/bin/sh", "-c"]
          args:
            - |
              while true; do
                echo "Running containerd snapshot prune..."
                ctr -n k8s.io snapshots prune
                echo "Prune finished. Sleeping for 24 hours."
                sleep 86400
              done
          securityContext:
            privileged: true # Required to access containerd socket
          volumeMounts:
            - name: containerd-socket
              mountPath: /run/containerd/containerd.sock
      volumes:
        - name: containerd-socket
          hostPath:
            path: /run/containerd/containerd.sock
            type: Socket
      # Tolerations to run on control-plane nodes as well
      tolerations:
        - key: "node-role.kubernetes.io/control-plane"
          operator: "Exists"
          effect: "NoSchedule"
        - key: "node-role.kubernetes.io/master"
          operator: "Exists"
          effect: "NoSchedule"
      serviceAccountName: containerd-snapshot-gc # Requires SA below
      terminationGracePeriodSeconds: 30
