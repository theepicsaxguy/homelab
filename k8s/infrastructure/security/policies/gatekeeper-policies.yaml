apiVersion: templates.gatekeeper.sh/v1
kind: ConstraintTemplate
metadata:
  name: k8spspprohibited
  annotations:
    description: "NSA/CISA - Prohibit privileged PSPs"
spec:
  crd:
    spec:
      names: ["podsecuritypolicies"]
  targets:
    - apiGroups: ["policy"]
      kinds: ["PodSecurityPolicy"]
      versions: ["v1beta1"]
    - apiGroups: [""]
      kinds: ["Pod"]
      versions: ["v1"]
  rego: |
    package k8spspprohibited
    
    violation[{"msg": msg, "details": {"restrictedFields": restricted}} {
      input := review.object
      restricted := {vfields: [_]}

      # Check for privileged pods
      privileged := input.spec.containers[_].securityContext.privileged == true
      field_error := {vfields: ["spec.containers[_].securityContext.privileged"]}
      
      # Check for host network access
      hostNetwork := input.spec.containers[_].hostNetwork == true
      host_network_error := {vfields: ["spec.containers[_].securityContext.hostNetwork"]}
      
      # Check for host PID
      hostPID := input.spec.containers[_].securityContext.hostPID == true
      host_pid_error := {vfields: ["spec.containers[_].securityContext.hostPID"]}
      
      # Check for host IPC
      hostIPC := input.spec.containers[_].securityContext.hostIPC == true
      host_ipc_error := {vfields: ["spec.containers[_].securityContext.hostIPC"]}
      
      # Check for adding capabilities
      add_caps := input.spec.containers[_].securityContext.capabilities.add[_]
      add_caps_error := {vfields: ["spec.containers[_].securityContext.capabilities.add"]}

      msg := sprintf("Pod Security Policy violation: %v", restricted)
    }
    
    enforcementAction: deny
---
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8sPSPRestrictions
metadata:
  name: nsa-restricted-psp
  annotations:
    description: "NSA/CISA - Restricted Pod Security Policy"
spec:
  match:
    kinds:
    - apiGroups: [""]
      kinds: ["Pod"]
    namespaces: ["*"]
  parameters:
    allowPrivileged: false
    allowHostNetwork: false
    allowHostPID: false
    allowHostIPC: false
    allowHostPorts: []
    allowedCapabilities: []
    readOnlyRootFilesystem: false
    runAsUser:
      rule: "MustRunAsNonRoot"
  exclusions:
    namespaces: ["security-system", "gatekeeper-system", "kyverno", "kubearmor", "kube-system"]
