apiVersion: batch/v1
kind: Job
metadata:
  name: fix-postgresql-conf
  namespace: auth
spec:
  template:
    spec:
      restartPolicy: Never
      securityContext:
        runAsNonRoot: true
        runAsUser: 26  # postgres user
        runAsGroup: 26
        fsGroup: 26
        seccompProfile:
          type: RuntimeDefault
      containers:
      - name: fix-config
        image: busybox
        command:
        - sh
        - -c
        - |
          cd /data/pgdata

          echo "=== Current postgresql.conf shared_preload_libraries ==="
          grep shared_preload_libraries postgresql.conf || echo "Not found"

          echo ""
          echo "=== Removing bg_mon from shared_preload_libraries ==="
          sed -i "s/shared_preload_libraries = 'bg_mon'/# shared_preload_libraries = 'bg_mon' # Removed Zalando extension/" postgresql.conf

          echo ""
          echo "=== Also trying alternative formats ==="
          sed -i "s/shared_preload_libraries = \"bg_mon\"/# shared_preload_libraries = \"bg_mon\" # Removed Zalando extension/" postgresql.conf
          sed -i "/^shared_preload_libraries.*bg_mon/s/^/# /" postgresql.conf

          echo ""
          echo "=== Cleaning up other Zalando artifacts ==="
          rm -f patroni.dynamic.json

          echo ""
          echo "=== Disabling SSL (old Zalando config requires certs we don't have) ==="
          sed -i 's/^ssl = on/# ssl = on # Disabled for CNPG/' postgresql.conf
          sed -i "s/^ssl = 'on'/# ssl = 'on' # Disabled for CNPG/" postgresql.conf
          sed -i 's/^ssl_cert_file/# ssl_cert_file/' postgresql.conf
          sed -i 's/^ssl_key_file/# ssl_key_file/' postgresql.conf
          grep -i "^ssl" postgresql.conf || echo "SSL disabled"

          echo ""
          echo "=== New postgresql.conf shared_preload_libraries ==="
          grep shared_preload_libraries postgresql.conf || echo "Not found"

          echo ""
          echo "=== Cleanup complete ==="
        volumeMounts:
        - name: pgdata
          mountPath: /data
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
      volumes:
      - name: pgdata
        persistentVolumeClaim:
          claimName: authentik-postgresql-1

