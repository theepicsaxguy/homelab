apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization

namespace: security-system

resources:
# Gatekeeper v3.21.0 - NSA/CISA admission control
- https://raw.githubusercontent.com/open-policy-agent/gatekeeper/v3.21.0/deploy/gatekeeper.yaml

# Kyverno v1.16.2 - Policy validation + mutation (with security patches)
- https://github.com/kyverno/kyverno/releases/download/v1.16.2/install.yaml

# Falco v4.4.0 - Runtime security monitoring with eBPF driver
helmCharts:
- name: falcosecurity/falco
  repo: https://falcosecurity.github.io/charts
  version: 4.4.0
  release: falco
  namespace: security-system
  valuesInline:
    driver:
      enabled: true
      kind: ebpf
      ebpf:
        leastPrivileged: true
    falcosidekick:
      enabled: true
    resources:
      requests:
        cpu: 200m
        memory: 512Mi
      limits:
        cpu: 1000m
        memory: 1024Mi
    metrics:
      enabled: true
      service:
        create: true
        type: ClusterIP
        ports:
          metrics:
            port: 8765
            targetPort: 8765
            protocol: TCP
    serviceMonitor:
      enabled: true
        selector:
          matchLabels:
            app.kubernetes.io/name: falco

# KubeArmor v1.6.6 - Kernel-level security enforcement
helmCharts:
- name: kubearmor/kubearmor
  repo: https://kubearmor.github.io/charts
  version: 1.6.6
  release: kubearmor
  namespace: security-system
  valuesInline:
    kubearmor:
      resources:
        requests:
          cpu: 100m
          memory: 128Mi
        limits:
          cpu: 500m
          memory: 256Mi
      configMap:
        defaultFilePosture: audit
        defaultNetworkPosture: audit
        defaultCapabilitiesPosture: audit
    kubearmorRelay:
      enable: true
    kubearmorController:
      replicas: 1

# Monitoring integration with existing Prometheus stack
- monitoring.yaml
- externalsecret.yaml

# Security Policies for All Namespaces (wildcard protection)
patchesStrategicMerge:
# Gatekeeper Constraints - NSA/CISA hardening policies
- |-
  apiVersion: templates.gatekeeper.sh/v1
  kind: ConstraintTemplate
  metadata:
    name: k8spspprohibited
  annotations:
    description: "NSA/CISA - Prohibit privileged PSPs"
  spec:
    crd:
      spec:
        names: ["podsecuritypolicies"]
    targets:
      - apiGroups: ["policy"]
        kinds: ["PodSecurityPolicy"]
        versions: ["v1beta1"]
    targets:
      - apiGroups: [""]
        kinds: ["Pod"]
        versions: ["v1"]
    rego: |
      package k8spspprohibited
      
      violation[{"msg": msg, "details": {"restrictedFields": restricted}} {
        input := review.object
        restricted := {vfields: [_]}

        # Check for privileged pods
        privileged := input.spec.containers[_].securityContext.privileged == true
        field_error := {vfields: ["spec.containers[_].securityContext.privileged"]}
        
        # Check for host network access
        hostNetwork := input.spec.containers[_].hostNetwork == true
        host_network_error := {vfields: ["spec.containers[_].securityContext.hostNetwork"]}
        
        # Check for host PID
        hostPID := input.spec.containers[_].securityContext.hostPID == true
        host_pid_error := {vfields: ["spec.containers[_].securityContext.hostPID"]}
        
        # Check for host IPC
        hostIPC := input.spec.containers[_].securityContext.hostIPC == true
        host_ipc_error := {vfields: ["spec.containers[_].securityContext.hostIPC"]}
        
        # Check for adding capabilities
        add_caps := input.spec.containers[_].securityContext.capabilities.add[_]
        add_caps_error := {vfields: ["spec.containers[_].securityContext.capabilities.add"]}

        msg := sprintf("Pod Security Policy violation: %v", restricted)
      }
      
      enforcementAction: deny
- |-
  apiVersion: constraints.gatekeeper.sh/v1beta1
  kind: K8sPSPRestrictions
  metadata:
    name: nsa-restricted-psp
    annotations:
      description: "NSA/CISA - Restricted Pod Security Policy"
  spec:
    match:
      kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
      namespaces: ["*"]  # All namespaces
    parameters:
      allowPrivileged: false
      allowHostNetwork: false
      allowHostPID: false
      allowHostIPC: false
      allowHostPorts: []
      allowedCapabilities: []
      readOnlyRootFilesystem: false
      runAsUser:
        rule: "MustRunAsNonRoot"
    exclusions:
      namespaces: ["security-system", "gatekeeper-system", "kyverno", "kubearmor", "kube-system"]

# Kyverno Cluster Policies - NSA hardening for all namespaces
- |-
  apiVersion: kyverno.io/v1
  kind: ClusterPolicy
  metadata:
    name: nsa-hardening-all-namespaces
    annotations:
      description: "NSA/CISA hardening policies for all namespaces"
  spec:
    validationFailureAction: Audit
    rules:
    - name: require-non-root-containers
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces: ["*"]  # All namespaces
            selector: {}  # Match all pods
      validate:
        message: "Containers must not run as root user (NSA/CISA 3.4.4)"
        pattern:
          spec:
            securityContext:
              runAsNonRoot: true
    - name: require-dropped-capabilities
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces: ["*"]
      validate:
        message: "Containers must drop all Linux capabilities (NSA/CISA 5.1.5)"
        pattern:
          spec:
            securityContext:
              capabilities:
                drop: ["ALL"]
    - name: require-read-only-root-filesystem
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces: ["*"]
      validate:
        message: "Containers must have read-only root filesystem (NSA/CISA 4.2.1)"
        pattern:
          spec:
            securityContext:
              readOnlyRootFilesystem: true
    - name: disallow-host-namespace-sharing
      match:
        any:
        - resources:
            kinds:
            - Pod
            namespaces: ["*"]
      validate:
        message: "Containers must not share host namespace (NSA/CISA 5.2.2)"
        pattern:
          spec:
            securityContext:
              hostPID: false
              hostIPC: false
              hostNetwork: false

# Falco Custom Rules - Application-specific monitoring
- |-
  apiVersion: v1
  kind: ConfigMap
  metadata:
    name: falco-custom-rules
    namespace: security-system
  data:
    # Minecraft protection rules
    minecraft_rules.yaml: |
      - rule: Minecraft Shell Access
        desc: Detect shell access in Minecraft containers
        condition: >
          spawned_process and
          proc.name in (bash, sh, zsh, fish, ksh) and
          container.name contains "minecraft"
        output: >
          Shell access detected in Minecraft container (user=%user.name command=%proc.cmdline container=%container.name)
          priority: WARNING
        tags: [minecraft, shell, container]
      
      - rule: Minecraft File System Anomaly
        desc: Detect suspicious file access in Minecraft containers
        condition: >
          container.name contains "minecraft" and
          ((fd.typechar = 1 or fd.typechar = 1) and (fd.name in ("/etc/passwd", "/etc/shadow", "/root/.ssh"))
        output: >
          Sensitive file access in Minecraft container (user=%user.name file=%fd.name container=%container.name)
          priority: CRITICAL
        tags: [minecraft, filesystem, sensitive]
      
      - rule: Minecraft Network Anomaly
        desc: Detect unusual network activity in Minecraft containers
        condition: >
          container.name contains "minecraft" and
          (fd.typechar = 4 or fd.typechar = 4) and
          (fd.sip.name != "Minecraft" and
           (fd.sport != 25565 and fd.sport != 19132))
        output: >
          Unusual network activity in Minecraft container (user=%user.name sip=%fd.sip.name sport=%fd.sport container=%container.name)
          priority: WARNING
        tags: [minecraft, network, anomaly]
    
    # AI/ML workload protection rules
    ai_rules.yaml: |
      - rule: AI Model File Access
        desc: Detect unauthorized access to AI model files
        condition: >
          container.name matches "vllm|perplexica|open-webui|gpt-researcher" and
          ((fd.typechar = 1 or fd.typechar = 1) and 
           (fd.name contains ".bin" or fd.name contains ".model" or fd.name contains ".ckpt"))
        output: >
          AI model file access detected (user=%user.name file=%fd.name container=%container.name)
          priority: HIGH
        tags: [ai, model, security]
      
      - rule: AI Data Exfiltration
        desc: Detect potential data exfiltration from AI workloads
        condition: >
          container.name matches "vllm|perplexica|open-webui" and
          (fd.typechar = 4 or fd.typechar = 4) and
          (fd.sport not in [80, 443, 8000, 8080, 3000] and
           (fd.bytes > 1000000)  # Large outbound transfer
        output: >
          Potential AI data exfiltration (user=%user.name bytes=%fd.bytes sip=%fd.sip.name sport=%fd.sport container=%container.name)
          priority: CRITICAL
        tags: [ai, exfiltration, network]
    
    # Media service protection rules
    media_rules.yaml: |
      - rule: Media Service Privilege Escalation
        desc: Detect privilege escalation in media services
        condition: >
          container.name matches "jellyfin|immich" and
          (spawned_process and proc.name in (sudo, su, doas) and
           proc.pname exists and proc.pname != container.name)
        output: >
          Privilege escalation in media service (user=%user.name command=%proc.cmdline parent=%proc.pname container=%container.name)
          priority: HIGH
        tags: [media, privilege, escalation]
      
      - rule: Media File System Protection
        desc: Detect suspicious file modifications in media directories
        condition: >
          container.name matches "jellyfin|immich" and
          ((fd.typechar = 2 or fd.typechar = 2) and
           (fd.name contains "/media/" or fd.name contains "/config/") and
           not fd.name contains "/tmp/")
        output: >
          Suspicious media file modification (user=%user.name file=%fd.name operation=%fd.type.name container=%container.name)
          priority: WARNING
        tags: [media, filesystem, security]

# KubeArmor Custom Policies - Application-specific LSM policies
- |-
  apiVersion: security.kubearmor.com/v1
  kind: KubeArmorPolicy
  metadata:
    name: minecraft-lsm-policy
    namespace: minecraft
  spec:
      severity: medium
      selector:
        matchLabels:
          app.kubernetes.io/name: minecraft
      file:
        matchPaths:
          - path: /etc/passwd
          readOnly: false
            recursive: true
          action: Block
          - path: /etc/shadow
          readOnly: false
            recursive: true
          action: Block
          - path: /root/.ssh
          readOnly: false
            recursive: true
          action: Block
      network:
        matchEgress: []
        action:
          Audit
      process:
        matchPaths:
          - path: /bin/bash
          path: /bin/sh
          path: /bin/zsh
          path: /usr/bin/sudo
          path: /usr/bin/su
        action: Block
- |-
  apiVersion: security.kubearmor.com/v1
  kind: KubeArmorPolicy
  metadata:
    name: ai-workload-lsm-policy
    namespace: ai
  spec:
      severity: high
      selector:
        matchLabels:
          app.kubernetes.io/part-of: ai
      file:
        matchPaths:
          - path: /models
          readOnly: true
            recursive: true
          action: Block
          - path: /app/data
          readOnly: false
            recursive: true
          action: Audit
      network:
        matchEgress:
          - protocol: TCP
            ports: ["80", "443", "8000"]
        matchIngress:
          - protocol: TCP
            ports: ["80", "443", "8000"]
        action:
          Audit
      process:
        matchPaths:
          - path: /bin/netcat
          path: /bin/nc
          path: /bin/curl
          path: /usr/bin/wget
          action: Block
- |-
  apiVersion: security.kubearmor.com/v1
  kind: KubeArmorPolicy
  metadata:
    name: media-service-lsm-policy
    namespace: media
  spec:
      severity: medium
      selector:
        matchLabels:
          app.kubernetes.io/part-of: media
      file:
        matchDirectories:
          - dir: /config
            readOnly: true
            recursive: true
          - dir: /media
            readOnly: true
            recursive: true
        action: Audit
      network:
        matchEgress:
          - protocol: TCP
            ports: ["8096", "8920"]  # Jellyfin and Immich ports
        action:
          Audit
      process:
        matchPaths:
          - path: /bin/chmod
          path: /bin/chown
          action: Block