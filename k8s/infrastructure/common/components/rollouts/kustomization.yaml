apiVersion: kustomize.config.k8s.io/v1alpha1
kind: Component

namespace: argo-rollouts

resources:
- rollout-template.yaml

# Define base ConfigMap that will be merged with environment overrides
configMapGenerator:
- name: base-env-config
  behavior: merge
  literals:
    - ROLLOUT_TIMEOUT=60s
    - ANALYSIS_DURATION=5m

replacements:
- source:
    kind: ConfigMap
    name: base-env-config
    fieldPath: data.ROLLOUT_TIMEOUT
  targets:
  - select:
      kind: Rollout
    fieldPaths:
    - spec.strategy.canary.steps.[name=pause].pause.duration
    - spec.strategy.canary.steps.[name=wait].pause.duration
- source:
    kind: ConfigMap
    name: base-env-config
    fieldPath: data.ANALYSIS_DURATION
  targets:
  - select:
      kind: Rollout
    fieldPaths:
    - spec.strategy.canary.analysis.interval
    - spec.strategy.canary.analysis.templates[name=*].duration

patches:
- path: rollout-pattern.yaml
  target:
    kind: Rollout
    labelSelector: app.kubernetes.io/part-of=infrastructure

configurations:
- varreference.yaml
