apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  name: hassio-secrets
  namespace: home-assistant
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: bitwarden-backend
    kind: ClusterSecretStore
  target:
    name: hassio-secrets
    creationPolicy: Owner
    template:
      engineVersion: v2
      data:
        # This template merges the existing secrets.yaml content
        # with the new MQTT credentials.
        secrets.yaml: |
          {{ .existing_secrets_block }}
          mqtt_user: "{{ .mqtt_user }}"
          mqtt_password: "{{ .mqtt_password }}"

  # This block fetches ALL data needed for the template above
  data:
    # 1. Fetch the entire existing secrets block from your main Bitwarden item
    - secretKey: existing_secrets_block
      remoteRef:
        key: "app-hassio-secrets"

    # 2. Fetch the atomic MQTT credentials from the Z2M items
    - secretKey: mqtt_user
      remoteRef:
        key: "app-mqtt-user"
    - secretKey: mqtt_password
      remoteRef:
        key: "app-mqtt-password"
