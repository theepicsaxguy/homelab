apiVersion: apps/v1
kind: StatefulSet
metadata:
  labels:
    app.kubernetes.io/name: minecraft-bedrock
    app.kubernetes.io/part-of: games
  name: minecraft-bedrock
spec:
  replicas: 1
  serviceName: minecraft-bedrock
  selector:
    matchLabels:
      app.kubernetes.io/name: minecraft-bedrock
  template:
    metadata:
      labels:
        app.kubernetes.io/name: minecraft-bedrock
        app.kubernetes.io/part-of: games
      annotations:
        backup.velero.io/backup-volumes: data
    spec:
      hostNetwork: false
      hostPID: false
      hostIPC: false
      securityContext:
        runAsNonRoot: true
        runAsUser: 1000
        runAsGroup: 1000
        fsGroup: 1000
        seccompProfile:
          type: RuntimeDefault

      initContainers:
        - name: sync-plugin-configs
          image: busybox:1.36
          command:
            - sh
            - -c
            - |
              set -e
              echo "=== sync-plugin-configs: starting ==="
              rm -f /data/plugins/QuickSort*.jar 2>/dev/null || true
              count=0
              for f in /plugin-configs/*; do
                [ -f "$f" ] || continue
                key=$(basename "$f")
                path=$(echo "$key" | sed 's/__/\//g')
                dest="/data/plugins/$path"
                echo "  $key -> $dest"
                mkdir -p "$(dirname "$dest")"
                cp "$f" "$dest"
                count=$((count + 1))
              done
              if [ "$count" -eq 0 ]; then
                echo "=== sync-plugin-configs: no files found in /plugin-configs ==="
              else
                echo "=== sync-plugin-configs: synced $count file(s) ==="
              fi
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
            runAsNonRoot: true
            runAsUser: 1000
            runAsGroup: 1000
          volumeMounts:
            - mountPath: /data
              name: data
            - mountPath: /plugin-configs
              name: plugin-configs
              readOnly: true

      containers:
        - name: main
          image: itzg/minecraft-server:java25-jdk
          imagePullPolicy: Always
          securityContext:
            allowPrivilegeEscalation: false
            capabilities:
              drop:
                - ALL
            readOnlyRootFilesystem: false
          envFrom:
            - configMapRef:
                name: minecraft-bedrock
            - secretRef:
                name: minecraft-server-ops
          volumeMounts:
            - mountPath: /data
              name: data
          ports:
            - containerPort: 25565
              protocol: TCP
              name: minecraft-java
            - containerPort: 19132
              protocol: UDP
              name: mc-bedrock
          readinessProbe:
            tcpSocket:
              port: 25565
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 20
          livenessProbe:
            tcpSocket:
              port: 25565
            initialDelaySeconds: 300
            periodSeconds: 30
            timeoutSeconds: 1
            failureThreshold: 3
          resources:
            requests:
              memory: '1Gi'
              cpu: '2000m'
            limits:
              memory: '6Gi'
              cpu: '6000m'
      volumes:
        - name: plugin-configs
          projected:
            sources:
              - configMap:
                  name: geyser-config
              - configMap:
                  name: luckperms-config
              - configMap:
                  name: luckperms-groups
              - configMap:
                  name: essentialsx-config
              - configMap:
                  name: wildloaders-config
              - configMap:
                  name: bedrockgui-config
  volumeClaimTemplates:
    - metadata:
        name: data
        labels:
          app.kubernetes.io/name: minecraft-bedrock
          app.kubernetes.io/part-of: media
      spec:
        accessModes:
          - ReadWriteOnce
        storageClassName: proxmox-csi
        resources:
          requests:
            storage: 5Gi
