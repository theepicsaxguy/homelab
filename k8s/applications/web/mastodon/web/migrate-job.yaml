apiVersion: batch/v1
kind: Job
metadata:
  name: mastodon-migrate
  namespace: mastodon
  annotations:
    helm.sh/hook: pre-install,pre-upgrade
spec:
  template:
    spec:
      serviceAccountName: mastodon-eso-reader
      containers:
        - name: migrate
          image: ghcr.io/glitch-soc/mastodon:v4.4.3
          command:
            - /bin/bash
            - -c
            - bundle exec rails db:migrate
          envFrom:
            - secretRef:
                name: mastodon-app-secrets
            - secretRef:
                name: mastodon-db-url
            - configMapRef:
                name: mastodon-env
          volumeMounts:
            - name: db-ca
              mountPath: /opt/mastodon/.postgresql/root.crt
              subPath: ca.crt
      restartPolicy: OnFailure
      volumes:
        - name: db-ca
          secret:
            secretName: mastodon-postgresql-server
            items:
              - key: ca.crt
                path: ca.crt
