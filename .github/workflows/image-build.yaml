name: Build and Push Docker Images

on:
  push:
    branches:
      - main
    paths:
      - 'images/**'
    tags:
      - '*-*'
  pull_request:
    paths:
      - 'images/**'

permissions:
  contents: read
  packages: write

jobs:
  detect-dockerfiles:
    runs-on: ubuntu-latest
    outputs:
      images: ${{ steps.detect.outputs.images }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Detect Dockerfiles
        id: detect
        run: |
          DOCKERFILES=$(find images/ -name "Dockerfile")
          IMAGES=$(echo "$DOCKERFILES" | while read path; do
            dirname=$(dirname "$path")
            relative_path=$(realpath --relative-to=images/ "$dirname")
            echo "$relative_path"
          done)
          JSON_ARRAY=$(echo "$IMAGES" | sort -u | jq -R -s -c 'split("\n")[:-1]')
          echo "images=$JSON_ARRAY" >> $GITHUB_OUTPUT

  build:
    runs-on: ubuntu-latest
    needs: detect-dockerfiles
    strategy:
      matrix:
        image: ${{ fromJson(needs.detect-dockerfiles.outputs.images) }}
      fail-fast: false

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract base image and version tags
        id: image-tags
        run: |
          DOCKERFILE=images/${{ matrix.image }}/Dockerfile

          FROM_LINE=$(grep -m 1 "^FROM" "$DOCKERFILE")
          BASE_IMAGE=$(echo "$FROM_LINE" | awk '{print $2}')
          BASE_IMAGE_TAG=$(echo "$BASE_IMAGE" | cut -d':' -f2-)
          [ -z "$BASE_IMAGE_TAG" ] && BASE_IMAGE_TAG="latest"

          IMAGE_VERSION=$(grep "ARG SAB_VERSION=" "$DOCKERFILE" | cut -d'=' -f2)
          if [ -z "$IMAGE_VERSION" ]; then
            IMAGE_VERSION=$(grep "ARG IMAGE_VERSION=" "$DOCKERFILE" | cut -d'=' -f2)
          fi
          [ -z "$IMAGE_VERSION" ] && IMAGE_VERSION="latest"

          if [[ "$GITHUB_REF_TYPE" == "tag" ]]; then
            TAG_IMAGE_NAME="${GITHUB_REF_NAME%%-*}"
            TAG_IMAGE_VERSION="${GITHUB_REF_NAME#*-}"
            if [[ "$TAG_IMAGE_NAME" == "${{ matrix.image }}" ]]; then
              IMAGE_VERSION="$TAG_IMAGE_VERSION"
            fi
          fi

          echo "base_tag=$BASE_IMAGE_TAG" >> $GITHUB_OUTPUT
          echo "image_version=$IMAGE_VERSION" >> $GITHUB_OUTPUT
      - name: Generate revision tag
        id: revision
        run: |
          REVISION_TAG="${{ steps.image-tags.outputs.image_version }}-$(echo ${{ github.sha }} | cut -c1-7)"
          echo "revision_tag=$REVISION_TAG" >> $GITHUB_OUTPUT


      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: images/${{ matrix.image }}
          file: images/${{ matrix.image }}/Dockerfile
          pull: true
          push: true
          build-args: |
            SAB_VERSION=${{ steps.image-tags.outputs.image_version }}
          platforms: linux/amd64
          cache-from: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:buildcache
          cache-to: type=registry,ref=ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:buildcache,mode=max
          tags: |
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:latest
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ steps.image-tags.outputs.base_tag }}
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ steps.image-tags.outputs.image_version }}
            ghcr.io/${{ github.repository_owner }}/${{ matrix.image }}:${{ steps.revision.outputs.revision_tag }}