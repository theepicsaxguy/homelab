apiVersion: v1
kind: ServiceAccount
metadata:
  name: pgbouncer
---
apiVersion: v1
data:
  pgbouncer.ini: |
    [databases]
    [pgbouncer]
    listen_addr = *
    listen_port = 5432
    auth_file = /etc/userlist/userlist.txt
    admin_users = admin
    server_reset_query = SELECT pg_advisory_unlock_all()
    server_reset_query_always = 1
kind: ConfigMap
metadata:
  name: pgbouncer-configmap
---
apiVersion: v1
data:
  userlist.txt: null
kind: Secret
metadata:
  name: pgbouncer-userlist-secret
---
apiVersion: v1
kind: Service
metadata:
  name: pgbouncer
spec:
  internalTrafficPolicy: Cluster
  ports:
  - name: psql
    port: 5432
    protocol: TCP
    targetPort: psql
  type: ClusterIP
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: pgbouncer
spec:
  selector:
    matchLabels:
      app: pgbouncer
  replicas: 1
  revisionHistoryLimit: 10
  template:
    metadata:
      labels:
        app: pgbouncer
    spec:
      containers:
      - image: ghcr.io/icoretech/pgbouncer-docker:1.24.1
        imagePullPolicy: IfNotPresent
        livenessProbe:
          initialDelaySeconds: 60
          periodSeconds: 10
          tcpSocket:
            port: 5432
        name: pgbouncer
        ports:
        - containerPort: 5432
          name: psql
          protocol: TCP
        readinessProbe:
          initialDelaySeconds: 10
          periodSeconds: 5
          tcpSocket:
            port: 5432
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
          runAsGroup: 70
          runAsNonRoot: true
          runAsUser: 70
        volumeMounts:
        - mountPath: /tmp
          name: tmp
        - mountPath: /etc/pgbouncer/
          name: config
        - mountPath: /etc/userlist/
          name: userlist
      serviceAccountName: pgbouncer
      terminationGracePeriodSeconds: 30
      volumes:
      - emptyDir: {}
        name: tmp
      - configMap:
          name: pgbouncer-configmap
        name: config
      - name: userlist
        secret:
          secretName: pgbouncer-userlist-secret